<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Active Deals | Sovereign Hub</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@600;700;800;900&family=JetBrains+Mono:wght@500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.min.js"></script>
    <link rel="stylesheet" href="css/dashboard.css">
    <style>
        /* ‚îÄ‚îÄ NAV ‚îÄ‚îÄ */
        .trinity-nav {
            background: var(--shark-obsidian);
            height: 72px; display: grid;
            grid-template-columns: 200px 1fr 200px;
            align-items: center; padding: 0 32px;
            border-bottom: 1px solid rgba(255,255,255,0.07);
            position: sticky; top: 0; z-index: 5000;
        }
        .nav-left  { display:flex; justify-content:flex-start; }
        .nav-right { display:flex; justify-content:flex-end; align-items:center; gap:14px; }
        .nav-center { display:flex; justify-content:center; overflow:hidden; }
        .nav-quote { color:white; font-weight:700; text-transform:uppercase; letter-spacing:5px; font-size:.58rem; opacity:.4; text-align:center; transition:opacity .3s; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
        .btn-ret {
            background:rgba(255,255,255,0.05); border:1.5px solid rgba(255,255,255,0.1);
            color:#94a3b8; text-decoration:none; padding:8px 16px; border-radius:10px;
            font-size:.72rem; font-weight:800; text-transform:uppercase; letter-spacing:1px; transition:.25s;
            white-space:nowrap;
        }
        .btn-ret:hover { background:var(--shark-indigo); color:white; transform:translateX(-3px); }
        .c-node { width:36px; height:36px; position:relative; display:flex; align-items:center; justify-content:center; cursor:pointer; flex-shrink:0; }
        .s-core  { width:8px; height:8px; background:white; border-radius:50%; box-shadow:0 0 10px #fff,0 0 20px var(--shark-indigo); z-index:5; }
        .o-ring  { position:absolute; width:100%; height:100%; border:1px solid rgba(99,102,241,0.3); border-radius:50%; animation:orb 10s linear infinite; }
        @keyframes orb { to { transform:rotate(360deg); } }

        /* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
        .page-header {
            background: var(--shark-obsidian);
            background-image:
                radial-gradient(ellipse at 80% 0%, rgba(16,185,129,0.2) 0%, transparent 52%),
                radial-gradient(ellipse at 5% 100%, rgba(99,102,241,0.1) 0%, transparent 48%);
            padding: 4.5rem 0 9.5rem;
            position: relative; overflow: hidden;
        }
        .page-header::before {
            content:''; position:absolute; inset:0;
            background-image: linear-gradient(rgba(16,185,129,0.025) 1px,transparent 1px),
                              linear-gradient(90deg,rgba(16,185,129,0.025) 1px,transparent 1px);
            background-size:52px 52px;
            mask-image:radial-gradient(ellipse at 50% 50%,black 10%,transparent 70%);
            pointer-events:none;
        }
        .ph-inner { max-width:1380px; margin:0 auto; padding:0 36px; }
        .ph-eyebrow { font-size:.56rem; font-weight:900; letter-spacing:5px; color:var(--shark-emerald); text-transform:uppercase; margin-bottom:10px; display:block; }
        .ph-title { font-size:3.2rem; font-weight:900; letter-spacing:-3px; color:white; line-height:1; margin-bottom:.7rem; }
        .ph-sub   { color:rgba(255,255,255,0.38); font-weight:600; font-size:.83rem; line-height:1.6; max-width:400px; margin-bottom:1.8rem; }

        /* Pills */
        .ph-pills { display:flex; gap:10px; flex-wrap:wrap; }
        .ph-pill  { background:rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.09); border-radius:14px; padding:12px 18px; text-align:center; min-width:88px; }
        .ph-val   { font-size:1.3rem; font-weight:900; color:white; letter-spacing:-1px; display:block; line-height:1; }
        .ph-lbl   { font-size:.48rem; font-weight:800; color:rgba(255,255,255,0.3); text-transform:uppercase; letter-spacing:1.5px; margin-top:5px; display:block; }
        .ph-pill.g  { background:rgba(16,185,129,0.12); border-color:rgba(16,185,129,0.25); } .ph-pill.g .ph-val  { color:#6ee7b7; }
        .ph-pill.i  { background:rgba(99,102,241,0.15); border-color:rgba(99,102,241,0.3);  } .ph-pill.i .ph-val  { color:#a5b4fc; }
        .ph-pill.y  { background:rgba(245,158,11,0.12); border-color:rgba(245,158,11,0.25); } .ph-pill.y .ph-val  { color:#fcd34d; }

        /* ‚îÄ‚îÄ LAYOUT ‚îÄ‚îÄ */
        .deals-layout {
            max-width: 1380px;
            margin: -5rem auto 6rem;
            display: grid;
            grid-template-columns: 1fr 320px;
            gap: 1.8rem;
            padding: 0 20px;
        }

        /* ‚îÄ‚îÄ SECTION LABEL ‚îÄ‚îÄ */
        .sec-lbl { font-size:.56rem; font-weight:900; text-transform:uppercase; letter-spacing:3px; color:#94a3b8; margin-bottom:.9rem; display:flex; align-items:center; gap:10px; }
        .sec-lbl::after { content:''; flex:1; height:1px; background:var(--shark-border); }

        /* ‚îÄ‚îÄ DEAL CARD ‚îÄ‚îÄ */
        .deal-card {
            background: white;
            border-radius: 20px;
            border: 1px solid var(--shark-border);
            box-shadow: 0 2px 12px rgba(0,0,0,0.04);
            margin-bottom: .9rem;
            transition: .26s cubic-bezier(0.23,1,0.32,1);
            overflow: hidden;
            cursor: pointer;
            display: block;
            text-decoration: none;
            color: inherit;
        }
        .deal-card:hover { transform:translateY(-4px); border-color:rgba(16,185,129,0.3); box-shadow:0 14px 32px rgba(16,185,129,0.09); }
        .deal-card:last-child { margin-bottom:0; }

        /* Top accent bar ‚Äî colour per role */
        .deal-card-inner { padding:1.7rem; }
        .dc-accent { height:3px; width:100%; }
        .dc-accent.founder  { background:linear-gradient(90deg,#6366f1,#818cf8); }
        .dc-accent.investor { background:linear-gradient(90deg,#10b981,#34d399); }

        /* Top row */
        .dc-top { display:flex; justify-content:space-between; align-items:center; margin-bottom:.9rem; }
        .dc-code { font-family:'JetBrains Mono',monospace; font-size:.56rem; font-weight:700; padding:3px 10px; border-radius:7px; }
        .dc-code.founder  { color:#6366f1; background:#f5f3ff; border:1px solid #e0e7ff; }
        .dc-code.investor { color:#059669; background:#f0fdf4; border:1px solid #d1fae5; }
        .dc-meta { display:flex; align-items:center; gap:8px; }
        .dc-date { font-size:.6rem; color:#94a3b8; font-weight:700; }
        .role-badge { padding:3px 10px; border-radius:20px; font-size:.56rem; font-weight:800; text-transform:uppercase; letter-spacing:.3px; }
        .role-badge.founder  { background:#eff6ff; color:#2563eb; border:1px solid #bfdbfe; }
        .role-badge.investor { background:#ecfdf5; color:#059669; border:1px solid #a7f3d0; }

        /* Title */
        .dc-title { font-size:1.25rem; font-weight:900; letter-spacing:-.03em; color:var(--shark-obsidian); margin-bottom:.25rem; line-height:1.2; }
        .dc-cat   { font-size:.7rem; color:#64748b; font-weight:700; margin-bottom:1rem; }

        /* Stats grid */
        .dc-stats { display:grid; grid-template-columns:repeat(3,1fr); gap:8px; margin-bottom:1rem; }
        .ds-cell  { border-radius:12px; padding:11px 13px; }
        .ds-cell.g  { background:#f0fdf4; border:1px solid #d1fae5; }
        .ds-cell.y  { background:#fefce8; border:1px solid #fef08a; }
        .ds-cell.i  { background:#f5f3ff; border:1px solid #e0e7ff; }
        .ds-lbl { font-size:.48rem; font-weight:800; text-transform:uppercase; letter-spacing:1.5px; display:block; margin-bottom:3px; }
        .ds-cell.g .ds-lbl { color:#059669; } .ds-cell.g .ds-val { color:#065f46; }
        .ds-cell.y .ds-lbl { color:#b45309; } .ds-cell.y .ds-val { color:#92400e; }
        .ds-cell.i .ds-lbl { color:#4f46e5; } .ds-cell.i .ds-val { color:#3730a3; }
        .ds-val { font-size:.92rem; font-weight:900; }

        /* Partner footer */
        .dc-footer { display:flex; align-items:center; justify-content:space-between; background:#f8fafc; border-radius:12px; padding:11px 14px; }
        .dc-partner { display:flex; align-items:center; gap:9px; min-width:0; }
        .dc-av { width:30px; height:30px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:.72rem; font-weight:900; color:white; flex-shrink:0; }
        .dc-pn { font-size:.82rem; font-weight:800; color:var(--shark-obsidian); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
        .dc-pr { font-size:.6rem; color:#94a3b8; font-weight:700; }
        .dc-btns { display:flex; gap:7px; flex-shrink:0; }
        .dc-btn { padding:7px 13px; border-radius:9px; font-size:.7rem; font-weight:800; text-decoration:none; border:1.5px solid; transition:.18s; white-space:nowrap; }
        .dc-btn.msg  { color:var(--shark-indigo); border-color:rgba(99,102,241,0.4); background:white; }
        .dc-btn.msg:hover  { background:var(--shark-indigo); color:white; border-color:var(--shark-indigo); }
        .dc-btn.view { color:var(--shark-obsidian); border-color:var(--shark-border); background:white; }
        .dc-btn.view:hover { background:var(--shark-obsidian); color:white; border-color:var(--shark-obsidian); }

        /* ‚îÄ‚îÄ SIDEBAR ‚îÄ‚îÄ */
        .sb-wrap { position:sticky; top:88px; display:flex; flex-direction:column; gap:.9rem; }
        .sb-card { background:white; border-radius:18px; padding:1.4rem; border:1px solid var(--shark-border); box-shadow:0 2px 12px rgba(0,0,0,0.03); }
        .sb-title { font-size:.56rem; font-weight:900; text-transform:uppercase; letter-spacing:3px; color:var(--shark-indigo); margin-bottom:1rem; display:block; }
        .sb-row { display:flex; justify-content:space-between; align-items:center; padding:7px 0; border-bottom:1px solid #f8fafc; }
        .sb-row:last-child { border-bottom:none; }
        .sb-rl { font-size:.73rem; font-weight:700; color:#64748b; }
        .sb-rv { font-size:.86rem; font-weight:900; color:var(--shark-obsidian); }

        /* Sector bars */
        .sbar-row { display:flex; justify-content:space-between; align-items:center; margin-bottom:4px; }
        .sbar-name { font-size:.68rem; font-weight:800; color:#64748b; }
        .sbar-pct  { font-size:.66rem; font-weight:800; color:#94a3b8; }
        .sbar { height:4px; background:#f1f5f9; border-radius:10px; overflow:hidden; margin-bottom:10px; }
        .sbar-fill { height:100%; border-radius:10px; }

        /* Quote box */
        .qbox { background:linear-gradient(135deg,#020617,#1e1b4b); border-radius:15px; padding:1.2rem 1.4rem; border:1px solid rgba(99,102,241,0.2); }
        .qbox-ey { font-size:.48rem; font-weight:900; color:var(--shark-indigo); text-transform:uppercase; letter-spacing:3px; margin-bottom:.5rem; display:block; }
        .qbox-q  { font-size:.76rem; font-weight:700; color:rgba(255,255,255,0.75); line-height:1.55; }
        .qbox-a  { font-size:.6rem; color:rgba(255,255,255,0.28); margin-top:.4rem; display:block; font-weight:600; }

        /* CTA buttons */
        .cta-btn { display:block; text-align:center; padding:11px; border-radius:11px; font-weight:800; font-size:.78rem; text-decoration:none; transition:.2s; margin-bottom:7px; }
        .cta-btn:last-child { margin-bottom:0; }
        .cta-btn.primary { background:var(--shark-indigo); color:white; }
        .cta-btn.primary:hover { background:#4f46e5; }
        .cta-btn.ghost { background:#f8fafc; color:var(--shark-obsidian); border:1.5px solid var(--shark-border); }
        .cta-btn.ghost:hover { border-color:var(--shark-obsidian); background:var(--shark-obsidian); color:white; }

        /* ‚îÄ‚îÄ EMPTY / LOADING ‚îÄ‚îÄ */
        .empty-pg { grid-column:1/-1; background:white; border-radius:20px; border:1px solid var(--shark-border); padding:5rem 3rem; text-align:center; box-shadow:0 4px 20px rgba(0,0,0,0.03); }
        .empty-icon  { font-size:2.8rem; margin-bottom:.8rem; }
        .empty-title { font-size:1.25rem; font-weight:900; letter-spacing:-.03em; color:var(--shark-obsidian); margin-bottom:.45rem; }
        .empty-desc  { color:#94a3b8; font-weight:600; font-size:.83rem; margin-bottom:1.5rem; }
        .empty-btn   { background:var(--shark-indigo); color:white; padding:11px 24px; border-radius:11px; font-weight:800; font-size:.8rem; text-decoration:none; display:inline-block; }
        .pg-loader { grid-column:1/-1; text-align:center; padding:6rem 0; }
        .pg-spinner { width:40px; height:40px; border:3px solid #e2e8f0; border-top-color:var(--shark-emerald); border-radius:50%; animation:orb 1s linear infinite; margin:0 auto 1rem; }

        @media (max-width:960px) {
            .deals-layout { grid-template-columns:1fr; }
            .sb-wrap { position:relative; top:0; }
            .trinity-nav { grid-template-columns:1fr auto; }
            .nav-center { display:none; }
            .ph-title { font-size:2.3rem; }
            .dc-stats { grid-template-columns:1fr 1fr; }
        }
    </style>
</head>
<body>

    <!-- NAV -->
    <nav class="trinity-nav">
        <div class="nav-left">
            <a href="dashboard.html" class="btn-ret">‚Üê Dashboard</a>
        </div>
        <div class="nav-center">
            <span id="navQ" class="nav-quote">Every deal is a promise kept.</span>
        </div>
        <div class="nav-right">
            <div id="clk" style="font-family:'JetBrains Mono';color:#4ade80;font-weight:800;font-size:.85rem;letter-spacing:1px;">00:00:00</div>
            <div class="c-node" onclick="cycleQ()">
                <div class="o-ring"></div>
                <div class="s-core"></div>
            </div>
        </div>
    </nav>

    <!-- HEADER -->
    <header class="page-header">
        <div class="ph-inner">
            <span class="ph-eyebrow">Verified Handshake Archive</span>
            <h1 class="ph-title">My Deals</h1>
            <p class="ph-sub">A forensic record of every closed contract, deployed capital, and active partnership.</p>
            <div class="ph-pills">
                <div class="ph-pill g"><span class="ph-val" id="phCapital">‚Çπ0</span><span class="ph-lbl">Total Capital</span></div>
                <div class="ph-pill"> <span class="ph-val" id="phDeals">0</span><span class="ph-lbl">Closed Deals</span></div>
                <div class="ph-pill y"><span class="ph-val" id="phEquity">‚Äî</span><span class="ph-lbl">Avg Equity</span></div>
                <div class="ph-pill i"><span class="ph-val" id="phValuation">‚Çπ0</span><span class="ph-lbl">Total Valuation</span></div>
            </div>
        </div>
    </header>

    <!-- MAIN -->
    <main class="deals-layout" id="mainLayout">
        <div class="pg-loader">
            <div class="pg-spinner"></div>
            <p style="color:#94a3b8;font-weight:700;font-size:.83rem;">Decrypting ledger...</p>
        </div>
    </main>

    <script src="js/config.js"></script>
    <script src="js/utils.js"></script>
    <script>
        // ‚îÄ‚îÄ QUOTES ‚îÄ‚îÄ
        const qs = [
            "Every deal is a promise kept.",
            "Capital is energy ‚Äî direct it wisely.",
            "Audit everything. Trust the process.",
            "Transparency is the only security.",
            "The handshake is the beginning, not the end.",
            "Risk is the price of progress.",
        ];
        let qi = Math.floor(Math.random() * qs.length);
        const navQ = document.getElementById('navQ');
        navQ.textContent = qs[qi];
        navQ.style.transition = 'opacity .25s';
        function cycleQ() {
            navQ.style.opacity = '0';
            setTimeout(() => { qi = (qi+1)%qs.length; navQ.textContent = qs[qi]; navQ.style.opacity = '.4'; }, 250);
        }
        setInterval(() => {
            document.getElementById('clk').textContent = new Date().toLocaleTimeString('en-US',{hour12:false});
        }, 1000);

        // ‚îÄ‚îÄ FORMAT ‚îÄ‚îÄ
        function fmt(n) {
            n = parseFloat(n) || 0;
            if (n >= 10000000) return '‚Çπ'+(n/10000000).toFixed(1).replace(/\.0$/,'')+'Cr';
            if (n >= 100000)   return '‚Çπ'+(n/100000).toFixed(1).replace(/\.0$/,'')+'L';
            if (n >= 1000)     return '‚Çπ'+(n/1000).toFixed(1).replace(/\.0$/,'')+'K';
            return '‚Çπ'+n.toLocaleString('en-IN');
        }

        // ‚îÄ‚îÄ INIT ‚îÄ‚îÄ
        async function init() {
            const { data: { user } } = await supabase.auth.getUser();
            if (!user) return window.location.href = 'auth.html';

            const { data: profile } = await supabase
                .from('users').select('role,full_name').eq('id', user.id).maybeSingle();
            const myRole = profile?.role || 'entrepreneur';

            const { data: deals } = await supabase
                .from('deals')
                .select(`
                    *,
                    proposals ( id, title, category ),
                    entrepreneur:entrepreneur_id ( full_name ),
                    investor:investor_id ( full_name )
                `)
                .or(`entrepreneur_id.eq.${user.id},investor_id.eq.${user.id}`)
                .order('deal_date', { ascending: false });

            // Remove loader
            document.getElementById('mainLayout').innerHTML = '';

            // ‚îÄ‚îÄ EMPTY STATE ‚îÄ‚îÄ
            if (!deals || deals.length === 0) {
                document.getElementById('mainLayout').innerHTML = `
                    <div class="empty-pg">
                        <div class="empty-icon">ü§ù</div>
                        <div class="empty-title">No deals yet</div>
                        <div class="empty-desc">${myRole==='investor'
                            ? 'Submit offers on proposals you believe in to close your first deal.'
                            : 'Accept an investor offer to close your first deal and see it appear here.'}</div>
                        <a href="${myRole==='investor' ? 'proposals.html' : 'dashboard.html'}" class="empty-btn">
                            ${myRole==='investor' ? 'üîç Browse Marketplace' : 'üì® View My Offers'}
                        </a>
                    </div>`;
                return;
            }

            // ‚îÄ‚îÄ COMPUTE STATS ‚îÄ‚îÄ
            let totalCapital  = 0;
            let totalValuation = 0;
            let totalEquity   = 0;
            const sectors = {};

            deals.forEach(d => {
                const cap = parseFloat(d.investment_amount||0);
                const eq  = parseFloat(d.equity_percentage||0);
                totalCapital   += cap;
                totalEquity    += eq;
                totalValuation += eq > 0 ? Math.round(cap / (eq/100)) : 0;
                const cat = d.proposals?.category || 'General';
                sectors[cat] = (sectors[cat]||0)+1;
            });
            const avgEquity = (totalEquity / deals.length).toFixed(1);

            // Pills
            document.getElementById('phCapital').textContent   = fmt(totalCapital);
            document.getElementById('phDeals').textContent     = deals.length;
            document.getElementById('phEquity').textContent    = avgEquity + '%';
            document.getElementById('phValuation').textContent = fmt(totalValuation);

            // ‚îÄ‚îÄ LEFT: DEAL CARDS ‚îÄ‚îÄ
            const leftCol = document.createElement('div');

            const secLabel = document.createElement('div');
            secLabel.className = 'sec-lbl';
            secLabel.textContent = `ü§ù Closed Contracts (${deals.length})`;
            leftCol.appendChild(secLabel);

            const SECTOR_COLORS = ['#6366f1','#10b981','#f59e0b','#ef4444','#8b5cf6','#06b6d4'];

            deals.forEach(d => {
                const isFounder  = d.entrepreneur_id === user.id;
                const partner    = isFounder ? d.investor : d.entrepreneur;
                const partnerName = partner?.full_name || 'Unknown';
                const capital    = parseFloat(d.investment_amount||0);
                const equity     = parseFloat(d.equity_percentage||0);
                const valuation  = equity > 0 ? Math.round(capital/(equity/100)) : 0;
                const dealDate   = d.deal_date
                    ? new Date(d.deal_date).toLocaleDateString('en-IN',{day:'numeric',month:'short',year:'numeric'})
                    : '‚Äî';
                const roleClass  = isFounder ? 'founder' : 'investor';
                const avatarBg   = isFounder ? '#6366f1' : '#10b981';
                const propId     = d.proposals?.id || '';

                const card = document.createElement('div');
                card.className = 'deal-card';
                card.onclick = () => { if (propId) window.location.href = `proposal-details.html?id=${propId}`; };
                card.innerHTML = `
                    <div class="dc-accent ${roleClass}"></div>
                    <div class="deal-card-inner">
                        <div class="dc-top">
                            <code class="dc-code ${roleClass}">DEAL_${d.id.substring(0,8).toUpperCase()}</code>
                            <div class="dc-meta">
                                <span class="role-badge ${roleClass}">${isFounder ? 'üöÄ Founder' : 'üèõÔ∏è Investor'}</span>
                                <span class="dc-date">${dealDate}</span>
                            </div>
                        </div>
                        <div class="dc-title">${d.proposals?.title || 'Unknown Proposal'}</div>
                        <div class="dc-cat">üè∑ ${d.proposals?.category || 'General'}</div>
                        <div class="dc-stats">
                            <div class="ds-cell g">
                                <span class="ds-lbl">${isFounder ? 'Capital Raised' : 'Capital Deployed'}</span>
                                <div class="ds-val">${fmt(capital)}</div>
                            </div>
                            <div class="ds-cell y">
                                <span class="ds-lbl">${isFounder ? 'Equity Given' : 'Equity Held'}</span>
                                <div class="ds-val">${equity}%</div>
                            </div>
                            <div class="ds-cell i">
                                <span class="ds-lbl">Implied Valuation</span>
                                <div class="ds-val">${fmt(valuation)}</div>
                            </div>
                        </div>
                        <div class="dc-footer" onclick="event.stopPropagation()">
                            <div class="dc-partner">
                                <div class="dc-av" style="background:${avatarBg};">${partnerName.charAt(0).toUpperCase()}</div>
                                <div style="min-width:0;">
                                    <div class="dc-pn">${partnerName}</div>
                                    <div class="dc-pr">${isFounder ? 'Your Investor Partner' : 'Founder / Entrepreneur'}</div>
                                </div>
                            </div>
                            <div class="dc-btns">
                                <a href="chat.html" class="dc-btn msg" onclick="event.stopPropagation()">üí¨ Chat</a>
                                <a href="proposal-details.html?id=${propId}" class="dc-btn view" onclick="event.stopPropagation()">View ‚Üí</a>
                            </div>
                        </div>
                    </div>`;
                leftCol.appendChild(card);
            });

            // ‚îÄ‚îÄ RIGHT: SIDEBAR ‚îÄ‚îÄ
            const sidebarEl = document.createElement('div');
            sidebarEl.className = 'sb-wrap';

            // Intelligence card
            const intelCard = document.createElement('div');
            intelCard.className = 'sb-card';
            intelCard.innerHTML = `
                <span class="sb-title">üìä Deal Intelligence</span>
                <div class="sb-row"><span class="sb-rl">Total Capital</span><span class="sb-rv" style="color:var(--shark-emerald);">${fmt(totalCapital)}</span></div>
                <div class="sb-row"><span class="sb-rl">Total Valuation</span><span class="sb-rv" style="color:var(--shark-indigo);">${fmt(totalValuation)}</span></div>
                <div class="sb-row"><span class="sb-rl">Closed Deals</span><span class="sb-rv">${deals.length}</span></div>
                <div class="sb-row"><span class="sb-rl">Avg Equity</span><span class="sb-rv" style="color:#f59e0b;">${avgEquity}%</span></div>
                <div class="sb-row"><span class="sb-rl">Avg Deal Size</span><span class="sb-rv">${fmt(totalCapital/deals.length)}</span></div>
                <div class="sb-row"><span class="sb-rl">Avg Valuation</span><span class="sb-rv">${fmt(totalValuation/deals.length)}</span></div>`;
            sidebarEl.appendChild(intelCard);

            // Sector breakdown ‚Äî always show even if 1 sector
            const sectorCard = document.createElement('div');
            sectorCard.className = 'sb-card';
            const sectorEntries = Object.entries(sectors);
            sectorCard.innerHTML = `
                <span class="sb-title">üè∑ Sector Mix</span>
                ${sectorEntries.map(([s,c], idx) => {
                    const pct = Math.round((c/deals.length)*100);
                    const color = SECTOR_COLORS[idx % SECTOR_COLORS.length];
                    return `<div class="sbar-row"><span class="sbar-name">${s}</span><span class="sbar-pct">${pct}%</span></div>
                            <div class="sbar"><div class="sbar-fill" style="width:${pct}%;background:${color};"></div></div>`;
                }).join('')}`;
            sidebarEl.appendChild(sectorCard);

            // Quote
            const tips = [
                { q:"Every deal is a promise ‚Äî fulfill it.", a:"Anonymous" },
                { q:"Risk is the price of progress.", a:"Unknown" },
                { q:"Price is what you pay. Value is what you get.", a:"Warren Buffett" },
                { q:"Done is better than perfect.", a:"Sheryl Sandberg" },
                { q:"Chase the vision, not the money.", a:"Tony Hsieh" },
                { q:"In investing, what is comfortable is rarely profitable.", a:"Robert Arnott" },
            ];
            const tip = tips[Math.floor(Math.random()*tips.length)];
            const quoteCard = document.createElement('div');
            quoteCard.className = 'sb-card';
            quoteCard.innerHTML = `
                <div class="qbox">
                    <span class="qbox-ey">‚ú¶ Deal Wisdom</span>
                    <div class="qbox-q">"${tip.q}"</div>
                    <span class="qbox-a">‚Äî ${tip.a}</span>
                </div>`;
            sidebarEl.appendChild(quoteCard);

            // CTA buttons
            const ctaCard = document.createElement('div');
            ctaCard.className = 'sb-card';
            ctaCard.innerHTML = `
                <a href="dashboard.html" class="cta-btn primary">‚Üê Dashboard</a>
                <a href="${myRole==='investor' ? 'investor-portfolio.html' : 'entrepreneur-portfolio.html'}" class="cta-btn ghost">
                    ${myRole==='investor' ? 'üèõÔ∏è Full Portfolio' : 'üöÄ My Ventures'}
                </a>
                <a href="funding-history.html" class="cta-btn ghost">üßæ Funding Ledger</a>
                <a href="chat.html" class="cta-btn ghost">üí¨ Messages</a>`;
            sidebarEl.appendChild(ctaCard);

            document.getElementById('mainLayout').appendChild(leftCol);
            document.getElementById('mainLayout').appendChild(sidebarEl);
        }

        window.onload = init;
    </script>
</body>
</html>