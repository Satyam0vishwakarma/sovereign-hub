<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Investment Case File | Sovereign Hub</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.min.js"></script>
    <link rel="stylesheet" href="css/dashboard.css">
    <style>
        /* --- 1. CASE FILE DESIGN SYSTEM --- */
        :root {
            --shark-obsidian: #020617;
            --shark-indigo: #6366f1;
            --shark-bg: #f8fafc;
            --shark-border: #e2e8f0;
            --shark-emerald: #10b981;
        }

        body { 
            background-color: var(--shark-bg); 
            color: var(--shark-obsidian); 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            margin: 0;
            -webkit-font-smoothing: antialiased;
        }

        /* --- 2. TRINITY TERMINAL NAV --- */
        .trinity-nav {
            background: var(--shark-obsidian);
            height: 80px;
            display: grid;
            grid-template-columns: 1fr 2fr 1fr;
            align-items: center;
            padding: 0 40px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            position: sticky; top: 0; z-index: 5000;
        }
        .nav-left { display: flex; justify-content: flex-start; }
        .nav-center { display: flex; justify-content: center; }
        .nav-right { display: flex; justify-content: flex-end; }
        
        .back-btn { 
            color: #94a3b8; text-decoration: none; font-weight: 700; font-size: 0.75rem; 
            text-transform: uppercase; letter-spacing: 2px; transition: 0.3s; 
        }
        .back-btn:hover { color: white; transform: translateX(-5px); }

        .central-statement { 
            color: white; font-weight: 800; text-transform: uppercase; letter-spacing: 4px; 
            font-size: 0.7rem; opacity: 0.7; margin: 0; text-align: center; 
            border-left: 1px solid rgba(255,255,255,0.1); border-right: 1px solid rgba(255,255,255,0.1); 
            padding: 0 30px; 
        }

        /* --- 3. FORENSIC HEADER --- */
        .details-header {
            background: var(--shark-obsidian);
            background-image: radial-gradient(circle at 100% 0%, rgba(99,102,241,0.15) 0%, transparent 40%);
            color: white; padding: 6rem 0 10rem 0; border-radius: 0 0 60px 60px;
        }
        .header-inner { max-width: 1300px; margin: 0 auto; padding: 0 2.5rem; }
        .hash-ref { font-family: 'JetBrains Mono', monospace; font-size: 0.7rem; color: #a5b4fc; background: rgba(165, 180, 252, 0.1); padding: 6px 12px; border-radius: 8px; display: inline-block; margin-bottom: 1.5rem; border: 1px solid rgba(165, 180, 252, 0.2); }
        .details-title { font-size: 3.5rem; font-weight: 900; letter-spacing: -3px; line-height: 1; margin-bottom: 1rem; }

        /* --- 4. CASE FILE GRID --- */
        .case-grid {
            max-width: 1300px;
            margin: -6rem auto 100px;
            display: grid;
            grid-template-columns: 420px 1fr;
            gap: 3rem;
            padding: 0 2rem;
        }

        .forensic-card {
            background: white; border-radius: 40px; padding: 3rem; border: 1px solid var(--shark-border);
            box-shadow: 0 30px 60px rgba(0,0,0,0.05); margin-bottom: 2rem;
        }

        .sidebar-sticky { position: sticky; top: 110px; }

        /* Counterparty Profile */
        .founder-pill { display: flex; align-items: center; gap: 20px; margin-bottom: 2rem; }
        .founder-avatar { width: 70px; height: 70px; border-radius: 50%; background: var(--shark-obsidian); color: white; display: flex; align-items: center; justify-content: center; font-weight: 900; font-size: 1.8rem; border: 4px solid var(--shark-bg); }
        
        .f-label { font-size: 0.6rem; font-weight: 800; color: #94a3b8; text-transform: uppercase; letter-spacing: 2px; display: block; margin-bottom: 8px; }
        .f-val { font-size: 1.1rem; font-weight: 800; color: var(--shark-obsidian); }

        /* Traction & Progress Nodes */
        .traction-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 1.5rem; }
        .traction-item { background: #f8fafc; padding: 18px; border-radius: 20px; border: 1px solid var(--shark-border); }

        .progress-container { margin: 2rem 0; }
        .progress-label-row { display: flex; justify-content: space-between; font-weight: 800; font-size: 0.65rem; color: var(--shark-indigo); text-transform: uppercase; margin-bottom: 10px; }
        .progress-bar-bg { width: 100%; height: 12px; background: #f1f5f9; border-radius: 10px; overflow: hidden; }
        .progress-bar-fill { height: 100%; background: linear-gradient(90deg, var(--shark-indigo), var(--shark-emerald)); transition: 1.5s cubic-bezier(0.16, 1, 0.3, 1); width: 0%; }

        /* Media Vault */
        .media-vault { display: flex; gap: 10px; margin-top: 2rem; }
        .media-btn { flex: 1; padding: 15px; border-radius: 15px; background: #f1f5f9; border: 1px solid var(--shark-border); text-decoration: none; color: var(--shark-obsidian); font-weight: 800; font-size: 0.7rem; text-align: center; transition: 0.3s; }
        .media-btn:hover { background: var(--shark-indigo); color: white; border-color: var(--shark-indigo); }

        /* Score Gauge */
        .score-box { background: #f8fafc; padding: 25px; border-radius: 30px; border: 1px solid var(--shark-border); text-align: center; }
        .score-val { font-size: 3.5rem; font-weight: 900; color: var(--shark-indigo); letter-spacing: -3px; }

        /* Financial Strips */
        .financial-nodes { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 2.5rem; }
        .f-node { background: white; padding: 25px; border-radius: 30px; border: 1px solid var(--shark-border); box-shadow: 0 4px 10px rgba(0,0,0,0.02); }
        .f-node.highlight { background: var(--shark-obsidian); color: white; border: none; }
        .f-node.highlight .f-label { color: rgba(255,255,255,0.5); }
        .f-node.highlight .f-val { color: var(--shark-emerald); font-size: 1.8rem; }

        /* Roadmap */
        .milestone-timeline { padding-left: 20px; border-left: 2px solid var(--shark-border); margin-top: 2rem; }
        .milestone-item { position: relative; padding-bottom: 2rem; padding-left: 25px; }
        .milestone-item::before { content: ""; position: absolute; left: -32px; top: 5px; width: 12px; height: 12px; border-radius: 50%; background: white; border: 3px solid var(--shark-indigo); z-index: 2; }
        .milestone-item.completed::before { background: var(--shark-emerald); border-color: var(--shark-emerald); }
        .milestone-title { font-weight: 800; font-size: 1rem; color: var(--shark-obsidian); display: block; }
        .milestone-date { font-size: 0.75rem; color: #94a3b8; font-weight: 700; }

        /* Buttons */
        .btn-action { width: 100%; padding: 20px; border-radius: 20px; font-weight: 800; text-transform: uppercase; letter-spacing: 1px; font-size: 0.8rem; cursor: pointer; border: none; transition: 0.3s; margin-bottom: 12px; text-decoration: none; display: flex; align-items: center; justify-content: center; }
        .btn-primary { background: var(--shark-obsidian); color: white; }
        .btn-primary:hover { background: var(--shark-indigo); transform: translateY(-3px); }
        .btn-outline { background: transparent; border: 2px solid var(--shark-border); color: var(--shark-obsidian); }
        .btn-outline:hover { background: #f8fafc; border-color: var(--shark-indigo); }

        .hidden { display: none !important; }
        .badge-status { padding: 6px 16px; border-radius: 50px; font-size: 0.65rem; font-weight: 900; letter-spacing: 1px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); text-transform: uppercase; }
    </style>
</head>
<body>

    <!-- TRINITY NAV -->
    <nav class="trinity-nav">
        <div class="nav-left"><a href="proposals.html" class="back-btn">‚Üê Back to Marketplace</a></div>
        <div class="nav-center"><h2 class="central-statement">Money can't buy happiness, isn't it?</h2></div>
        <div class="nav-right" style="display:flex; gap:15px; align-items:center;">
             <span id="viewCount" style="color:#94a3b8; font-weight:800; font-size:0.6rem; letter-spacing:1px;">VIEWS: 0</span>
             <span style="color:var(--shark-emerald); font-weight:900; font-size:0.6rem; border:1px solid var(--shark-emerald); padding:4px 10px; border-radius:6px;">LIVE_SYNC</span>
        </div>
    </nav>

    <!-- HEADER -->
    <header class="details-header">
        <div class="header-inner">
            <code class="hash-ref" id="displayHash">ASSET_HASH_SCANNING...</code>
            <h1 class="details-title" id="displayTitle">Case File</h1>
            <div style="display:flex; gap:15px; align-items:center;">
                <span id="displayCategory" class="badge-status" style="background:var(--shark-indigo); border:none;">CATEGORY</span>
                <span id="displayStatus" class="badge-status">STATUS</span>
            </div>
        </div>
    </header>

    <main class="case-grid">
        <!-- SIDEBAR -->
        <aside>
            <div class="sidebar-sticky">
                
                <!-- Traction Card -->
                <div class="forensic-card">
                    <span class="f-label">Market Traction Audit</span>
                    <div class="traction-grid">
                        <div class="traction-item">
                            <span class="f-label">Current Stage</span>
                            <div class="f-val" id="displayStage" style="font-size:0.9rem;">-</div>
                        </div>
                        <div class="traction-item">
                            <span class="f-label">Annual Revenue</span>
                            <div class="f-val" id="displayRevenue" style="font-size:0.9rem; color:var(--shark-emerald);">‚Çπ0</div>
                        </div>
                        <div class="traction-item" style="grid-column: 1 / -1; margin-top: 10px;">
                            <span class="f-label">Core Team Size</span>
                            <div class="f-val" id="displayTeam">1 Specialist</div>
                        </div>
                    </div>
                    
                    <div class="progress-container">
                        <div class="progress-label-row">
                            <span>Capital Raised</span>
                            <span id="progressPerc">0%</span>
                        </div>
                        <div class="progress-bar-bg">
                            <div id="progressBar" class="progress-bar-fill"></div>
                        </div>
                        <p style="font-size:0.6rem; color:#94a3b8; margin-top:10px; font-weight:700;">DEPLOYED ASSETS: <span id="raisedAmt" style="color:var(--shark-obsidian)">‚Çπ0</span></p>
                    </div>

                    <div class="media-vault">
                        <a id="deckLink" href="#" target="_blank" class="media-btn">üìÑ Pitch Deck</a>
                        <a id="videoLink" href="#" target="_blank" class="media-btn">üé¨ Video Pitch</a>
                    </div>
                </div>

                <!-- Founder Profile -->
                <div class="forensic-card">
                    <span class="f-label">Counterparty Founder</span>
                    <div class="founder-pill">
                        <div class="founder-avatar" id="founderAvatar">?</div>
                        <div>
                            <div class="f-val" id="displayFounder" style="font-size: 1.4rem; letter-spacing: -0.5px;">-</div>
                            <span style="color:var(--shark-emerald); font-size: 0.65rem; font-weight: 900;">‚úì VERIFIED ENTITY</span>
                        </div>
                    </div>
                    <a id="viewProfileLink" href="#" class="btn-action btn-outline">View Public Profile</a>
                </div>

                <!-- Commands -->
                <div class="forensic-card">
                    <span class="f-label">Capital Execution</span>
                    <div id="investorActions">
                        <button onclick="openOfferModal()" class="btn-action btn-primary">Execute Offer</button>
                        <button onclick="startChat()" class="btn-action btn-outline">Secure Message</button>
                    </div>
                    <div id="ownerActions" class="hidden">
                        <a href="#" id="editBtn" class="btn-action btn-primary">Modify Record</a>
                        <button onclick="deletePitch()" class="btn-action btn-outline" style="color:#ef4444;">Purge Entry</button>
                    </div>
                </div>

                <div class="forensic-card" style="text-align:center;">
                    <span class="f-label">Neural Performance Index</span>
                    <div class="score-box">
                        <div class="score-val" id="displayScore">0</div>
                        <span id="displayGrade" style="font-size:0.7rem; font-weight:900; color:var(--shark-indigo); text-transform:uppercase; letter-spacing:2px;">Audit Pending</span>
                    </div>
                </div>
            </div>
        </aside>

        <!-- MAIN COLUMN -->
        <div>
            <!-- Financial Strip -->
            <div class="financial-nodes">
                <div class="f-node highlight">
                    <span class="f-label">Target Funding Ask</span>
                    <div class="f-val" id="displayAmount">‚Çπ0</div>
                </div>
                <div class="f-node">
                    <span class="f-label">Equity Offered</span>
                    <div class="f-val" id="displayEquity">0%</div>
                </div>
                <div class="f-node">
                    <span class="f-label">Implied Valuation</span>
                    <div class="f-val" id="displayValuation">‚Çπ0</div>
                </div>
            </div>

            <!-- Executive Summary -->
            <div class="forensic-card">
                <h3 class="f-label" style="color:var(--shark-indigo); margin-bottom: 20px;">01. Executive Summary</h3>
                <div id="displayDescription" style="line-height: 1.8; font-size: 1.1rem; color: #475569; white-space: pre-wrap;">-</div>
            </div>

            <!-- Roadmap -->
            <div class="forensic-card">
                <h3 class="f-label" style="color:var(--shark-indigo); margin-bottom: 20px;">02. Execution Roadmap</h3>
                <div id="milestonesContainer" class="milestone-timeline">
                    <!-- Injected by JS -->
                </div>
            </div>

            <!-- Live Offer Ledger -->
            <div class="forensic-card">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 25px;">
                    <h3 class="f-label" style="color:var(--shark-indigo); margin:0;">03. Verified Offer Ledger</h3>
                    <span id="offerCount" class="badge-status" style="background:#f1f5f9; color:var(--shark-indigo); border:none;">0 ACTIVE OFFERS</span>
                </div>
                <div id="offersLedgerContainer">
                    <!-- Injected by JS -->
                </div>
            </div>
        </div>
    </main>

    <!-- OFFER MODAL -->
    <div id="offerModal" class="modal-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(2, 6, 23, 0.4); backdrop-filter: blur(8px); z-index: 6000; align-items: center; justify-content: center;">
        <div class="forensic-card" style="width: 450px; padding: 4rem;">
            <h2 style="font-weight: 900; letter-spacing: -1.5px; margin-bottom: 10px;">Submit Terms</h2>
            <p style="font-size: 0.85rem; color: #94a3b8; margin-bottom: 2.5rem; font-weight: 600;">Offer will be logged in the public ledger.</p>
            <form id="offerForm">
                <div style="margin-bottom: 20px;">
                    <label class="f-label">Capital (‚Çπ)</label>
                    <input type="number" id="offerAmount" required style="width:100%; padding:15px; border-radius:15px; border:1.5px solid var(--shark-border); font-weight:800; box-sizing:border-box;">
                </div>
                <div style="margin-bottom: 20px;">
                    <label class="f-label">Equity (%)</label>
                    <input type="number" id="offerEquity" step="0.1" required style="width:100%; padding:15px; border-radius:15px; border:1.5px solid var(--shark-border); font-weight:800; box-sizing:border-box;">
                </div>
                <div style="margin-bottom: 20px;">
                    <label class="f-label">Message (optional)</label>
                    <textarea id="offerMessage" rows="3" placeholder="Brief note to the founder..." style="width:100%; padding:15px; border-radius:15px; border:1.5px solid var(--shark-border); font-weight:600; font-family:inherit; resize:none; box-sizing:border-box;"></textarea>
                </div>
                <!-- Submit status message -->
                <div id="offerStatusMsg" style="display:none; padding:10px 15px; border-radius:12px; font-size:0.8rem; font-weight:700; margin-bottom:15px;"></div>
                <div style="display:flex; gap:10px; margin-top:2rem;">
                    <button type="button" onclick="closeOfferModal()" id="cancelOfferBtn" class="btn-action btn-outline" style="flex:1;">Cancel</button>
                    <button type="submit" id="transmitBtn" class="btn-action btn-primary" style="flex:2;">Transmit</button>
                </div>
            </form>
        </div>
    </div>

    <script src="js/config.js"></script>
    <script src="js/utils.js"></script>
    <script>
        console.log('[ProposalDetails] Script initializing...');

        const urlParams = new URLSearchParams(window.location.search);
        const pitchId   = urlParams.get('id');
        let pitchData   = null;
        let currentUser = null;

        console.log('[ProposalDetails] Pitch ID from URL:', pitchId);

        // ============================================================
        // INIT ‚Äî load proposal data and check auth
        // ============================================================
        async function initAudit() {
            console.log('[ProposalDetails] initAudit ‚Üí starting...');

            // Validate URL param
            if (!pitchId) {
                console.error('[ProposalDetails] initAudit ‚Üí no pitch ID in URL, redirecting to dashboard');
                window.location.href = 'dashboard.html';
                return;
            }

            // Auth check
            const { data: { user }, error: authErr } = await supabase.auth.getUser();
            if (authErr) {
                console.error('[ProposalDetails] initAudit ‚Üí auth error:', authErr);
                window.location.href = 'auth.html';
                return;
            }
            if (!user) {
                console.warn('[ProposalDetails] initAudit ‚Üí no session, redirecting to auth');
                window.location.href = 'auth.html';
                return;
            }
            currentUser = user;
            console.log('[ProposalDetails] initAudit ‚Üí user authenticated:', user.id, '| role will determine UI');

            // Fetch proposal with founder info and milestones
            console.log('[ProposalDetails] initAudit ‚Üí fetching proposal id:', pitchId);
            const { data: p, error: propErr } = await supabase
                .from('proposals')
                .select('*, users(*), milestones(*)')
                .eq('id', pitchId)
                .maybeSingle();

            if (propErr) {
                console.error('[ProposalDetails] initAudit ‚Üí proposal fetch error:', propErr);
                window.location.href = 'dashboard.html';
                return;
            }
            if (!p) {
                console.error('[ProposalDetails] initAudit ‚Üí proposal not found for id:', pitchId);
                window.location.href = 'dashboard.html';
                return;
            }

            pitchData = p;
            console.log('[ProposalDetails] initAudit ‚Üí proposal loaded:', p.title, '| owner:', p.user_id, '| viewer:', user.id);
            console.log('[ProposalDetails] initAudit ‚Üí viewer is owner:', user.id === p.user_id);

            // Increment view count
            const { error: viewErr } = await supabase
                .from('proposals')
                .update({ views: (p.views || 0) + 1 })
                .eq('id', pitchId);
            if (viewErr) console.warn('[ProposalDetails] initAudit ‚Üí view increment error:', viewErr);

            // ---- Populate Header ----
            document.getElementById('displayHash').textContent      = `HASH: ${p.id.substring(0,18).toUpperCase()}`;
            document.getElementById('displayTitle').textContent     = p.title;
            document.getElementById('displayCategory').textContent  = p.category;
            document.getElementById('displayStatus').textContent    = p.status;
            document.getElementById('viewCount').textContent        = `VIEWS: ${(p.views || 0) + 1}`;

            // ---- Traction Card ----
            document.getElementById('displayStage').textContent   = p.business_stage || 'Idea';
            document.getElementById('displayRevenue').textContent = `‚Çπ${parseFloat(p.revenue || 0).toLocaleString('en-IN')}`;
            document.getElementById('displayTeam').textContent    = `${p.team_size || 1} Specialist(s)`;

            // Progress bar
            const raised = parseFloat(p.funding_received || 0);
            const target = parseFloat(p.amount_needed || 1);
            const perc   = Math.min(Math.round((raised / target) * 100), 100);
            document.getElementById('progressBar').style.width   = perc + '%';
            document.getElementById('progressPerc').textContent  = perc + '%';
            document.getElementById('raisedAmt').textContent     = `‚Çπ${raised.toLocaleString('en-IN')}`;
            console.log(`[ProposalDetails] initAudit ‚Üí funding: ‚Çπ${raised} / ‚Çπ${target} (${perc}%)`);

            // Media links
            if (p.pitch_deck_url) document.getElementById('deckLink').href = p.pitch_deck_url;
            else document.getElementById('deckLink').style.opacity = '0.3';
            if (p.video_pitch_url) document.getElementById('videoLink').href = p.video_pitch_url;
            else document.getElementById('videoLink').style.opacity = '0.3';

            // ---- Financial Strip ----
            document.getElementById('displayAmount').textContent    = `‚Çπ${target.toLocaleString('en-IN')}`;
            document.getElementById('displayEquity').textContent    = `${p.equity_offered}%`;
            const impliedVal = p.equity_offered > 0 ? parseInt(target / (p.equity_offered / 100)) : 0;
            document.getElementById('displayValuation').textContent = `‚Çπ${impliedVal.toLocaleString('en-IN')}`;

            // ---- Description ----
            document.getElementById('displayDescription').textContent = p.description || 'No description provided.';

            // ---- Success Score ----
            const score = p.success_score || 0;
            document.getElementById('displayScore').textContent = score;
            const grade = document.getElementById('displayGrade');
            if (score >= 80)      grade.textContent = 'INVESTMENT GRADE A';
            else if (score >= 50) grade.textContent = 'MODERATE POTENTIAL B';
            else                  grade.textContent = 'HIGH RISK SPECULATION C';
            console.log(`[ProposalDetails] initAudit ‚Üí success score: ${score}`);

            // ---- Founder Info ----
            if (p.users) {
                document.getElementById('displayFounder').textContent    = p.users.full_name;
                document.getElementById('founderAvatar').textContent     = p.users.full_name.charAt(0).toUpperCase();
                document.getElementById('viewProfileLink').href          = `user-profile.html?id=${p.users.id}`;
                console.log('[ProposalDetails] initAudit ‚Üí founder:', p.users.full_name);
            } else {
                console.warn('[ProposalDetails] initAudit ‚Üí users join returned null ‚Äî founder name unavailable');
            }

            // ---- Milestones / Roadmap ----
            const mBox = document.getElementById('milestonesContainer');
            console.log(`[ProposalDetails] initAudit ‚Üí milestones found: ${p.milestones?.length ?? 0}`);
            if (p.milestones?.length) {
                mBox.innerHTML = p.milestones.map(m => {
                    const dateStr = m.target_date
                        ? new Date(m.target_date).toLocaleDateString('en-GB')
                        : 'TBD';
                    return `
                        <div class="milestone-item ${m.status === 'completed' ? 'completed' : ''}">
                            <span class="milestone-title">${m.title}</span>
                            <span class="milestone-date">${dateStr} ‚Ä¢ ${m.status.toUpperCase()}</span>
                        </div>`;
                }).join('');
            } else {
                mBox.innerHTML = '<p style="color:#94a3b8; font-size:0.8rem;">No milestones logged.</p>';
            }

            // ---- Owner vs Investor Actions ----
            if (user.id === p.user_id) {
                // This user owns the proposal ‚Äî show edit/delete, hide invest button
                console.log('[ProposalDetails] initAudit ‚Üí viewer is OWNER ‚Üí showing owner actions');
                document.getElementById('investorActions').classList.add('hidden');
                document.getElementById('ownerActions').classList.remove('hidden');
                document.getElementById('editBtn').href = `edit-proposal.html?id=${p.id}`;
            } else {
                console.log('[ProposalDetails] initAudit ‚Üí viewer is INVESTOR/GUEST ‚Üí showing offer actions');
            }

            // ---- Load existing offers in ledger ----
            await loadOffers();

            // ---- Attach offer form submit handler ----
            // THIS WAS THE BUG: the form had no submit listener so clicking
            // "Transmit" triggered native HTML form submission = page redirect.
            attachOfferFormHandler();

            console.log('[ProposalDetails] initAudit ‚Üí fully loaded ‚úÖ');
        }

        // ============================================================
        // LOAD OFFERS ‚Äî populates the Verified Offer Ledger section
        // ============================================================
        async function loadOffers() {
            console.log('[ProposalDetails] loadOffers ‚Üí fetching offers for proposal:', pitchId);
            const { data: offers, error } = await supabase
                .from('offers')
                .select('*, investor:investor_id(full_name)')
                .eq('proposal_id', pitchId)
                .order('created_at', { ascending: false });

            if (error) {
                console.error('[ProposalDetails] loadOffers ‚Üí error:', error);
                return;
            }

            console.log(`[ProposalDetails] loadOffers ‚Üí ${offers?.length ?? 0} offers found`);

            const container = document.getElementById('offersLedgerContainer');
            document.getElementById('offerCount').textContent = `${offers?.length || 0} ACTIVE OFFERS`;

            if (!offers?.length) {
                container.innerHTML = `<p style="opacity:0.4; text-align:center; padding:2rem;">NO LIVE OFFERS LOGGED.</p>`;
                return;
            }

            container.innerHTML = `
                <table style="width:100%; border-collapse:collapse;">
                    <thead>
                        <tr style="text-align:left; font-size:0.6rem; color:#94a3b8; text-transform:uppercase;">
                            <th style="padding-bottom:15px;">Investor Entity</th>
                            <th>Capital</th>
                            <th>Equity</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${offers.map(o => `
                            <tr style="border-top:1px solid #f1f5f9; font-size:0.9rem;">
                                <td style="padding:15px 0;"><strong>${o.investor?.full_name || 'Unknown'}</strong></td>
                                <td style="color:var(--shark-indigo); font-weight:800;">‚Çπ${parseFloat(o.amount).toLocaleString('en-IN')}</td>
                                <td>${o.equity_percentage}%</td>
                                <td><span style="font-size:0.6rem; font-weight:900; color:var(--shark-indigo);">${o.status.toUpperCase()}</span></td>
                            </tr>`).join('')}
                    </tbody>
                </table>`;
        }

        // ============================================================
        // OFFER FORM HANDLER
        // THE FIX: intercepts native form submit, runs async Supabase
        // insert instead, keeps user on the page.
        // ============================================================
        function attachOfferFormHandler() {
            const form = document.getElementById('offerForm');
            if (!form) {
                console.error('[ProposalDetails] attachOfferFormHandler ‚Üí #offerForm not found in DOM');
                return;
            }

            console.log('[ProposalDetails] attachOfferFormHandler ‚Üí submit listener attached to #offerForm');

            form.addEventListener('submit', async function(e) {
                // CRITICAL: prevent default HTML form submission (this was causing the redirect)
                e.preventDefault();
                e.stopPropagation();
                console.log('[ProposalDetails] offerForm submit ‚Üí intercepted, running async handler...');

                const transmitBtn  = document.getElementById('transmitBtn');
                const cancelBtn    = document.getElementById('cancelOfferBtn');
                const statusMsg    = document.getElementById('offerStatusMsg');
                const amountInput  = document.getElementById('offerAmount');
                const equityInput  = document.getElementById('offerEquity');
                const messageInput = document.getElementById('offerMessage');

                // Read values
                const amount  = parseFloat(amountInput.value);
                const equity  = parseFloat(equityInput.value);
                const message = messageInput?.value?.trim() || '';

                console.log(`[ProposalDetails] offerForm ‚Üí amount: ${amount}, equity: ${equity}%, message: "${message}"`);

                // Validate
                if (!amount || amount <= 0) {
                    console.warn('[ProposalDetails] offerForm ‚Üí validation failed: invalid amount');
                    showOfferStatus('error', '‚ö† Enter a valid capital amount greater than 0.');
                    return;
                }
                if (!equity || equity <= 0 || equity > 100) {
                    console.warn('[ProposalDetails] offerForm ‚Üí validation failed: invalid equity');
                    showOfferStatus('error', '‚ö† Equity must be between 0.1% and 100%.');
                    return;
                }
                if (!pitchData) {
                    console.error('[ProposalDetails] offerForm ‚Üí pitchData is null, cannot submit offer');
                    showOfferStatus('error', '‚ö† Proposal data not loaded. Please refresh.');
                    return;
                }
                if (!currentUser) {
                    console.error('[ProposalDetails] offerForm ‚Üí currentUser is null, not authenticated');
                    window.location.href = 'auth.html';
                    return;
                }

                // Prevent owner from making offer on own proposal
                if (currentUser.id === pitchData.user_id) {
                    console.warn('[ProposalDetails] offerForm ‚Üí owner tried to submit offer on own proposal');
                    showOfferStatus('error', '‚ö† You cannot submit an offer on your own proposal.');
                    return;
                }

                // Disable buttons during submission
                transmitBtn.disabled  = true;
                cancelBtn.disabled    = true;
                transmitBtn.textContent = 'TRANSMITTING...';
                hideOfferStatus();

                // Calculate implied valuation
                const impliedValuation = equity > 0 ? Math.round(amount / (equity / 100)) : null;
                console.log(`[ProposalDetails] offerForm ‚Üí implied valuation: ‚Çπ${impliedValuation}`);

                try {
                    console.log('[ProposalDetails] offerForm ‚Üí inserting offer into DB...');
                    console.log('[ProposalDetails] offerForm ‚Üí payload:', {
                        proposal_id:       pitchData.id,
                        investor_id:       currentUser.id,
                        amount:            amount,
                        equity_percentage: equity,
                        valuation:         impliedValuation,
                        message:           message,
                        status:            'pending'
                    });

                    const { data: newOffer, error: insertErr } = await supabase
                        .from('offers')
                        .insert({
                            proposal_id:       pitchData.id,
                            investor_id:       currentUser.id,
                            amount:            amount,
                            equity_percentage: equity,
                            valuation:         impliedValuation,
                            message:           message || null,
                            status:            'pending'
                        })
                        .select()
                        .maybeSingle();

                    if (insertErr) {
                        console.error('[ProposalDetails] offerForm ‚Üí DB insert error:', insertErr);
                        console.error('[ProposalDetails] offerForm ‚Üí error code:', insertErr.code, '| message:', insertErr.message, '| hint:', insertErr.hint);
                        throw insertErr;
                    }

                    console.log('[ProposalDetails] offerForm ‚Üí offer inserted successfully ‚úÖ | offer id:', newOffer?.id);

                    // Send notification to entrepreneur
                    console.log('[ProposalDetails] offerForm ‚Üí sending notification to entrepreneur:', pitchData.user_id);
                    const { error: notifErr } = await supabase.from('notifications').insert({
                        user_id: pitchData.user_id,
                        title:   'üí∞ New Investment Offer',
                        message: `An investor submitted ‚Çπ${amount.toLocaleString('en-IN')} for ${equity}% equity on "${pitchData.title}"`,
                        type:    'offer',
                        link:    `proposal-details.html?id=${pitchData.id}`
                    });
                    if (notifErr) console.warn('[ProposalDetails] offerForm ‚Üí notification insert warning:', notifErr);
                    else console.log('[ProposalDetails] offerForm ‚Üí notification sent to entrepreneur ‚úÖ');

                    // Success UI
                    showOfferStatus('success', '‚úÖ Offer transmitted! The founder will be notified.');
                    form.reset();

                    // Refresh offers ledger after short delay then close modal
                    setTimeout(async () => {
                        console.log('[ProposalDetails] offerForm ‚Üí refreshing offers ledger...');
                        await loadOffers();
                        closeOfferModal();
                        console.log('[ProposalDetails] offerForm ‚Üí modal closed, ledger refreshed ‚úÖ');
                    }, 2000);

                } catch (err) {
                    console.error('[ProposalDetails] offerForm ‚Üí CRITICAL submission error:', err);
                    showOfferStatus('error', '‚ö† Transmission failed: ' + (err.message || 'Unknown error'));
                } finally {
                    transmitBtn.disabled    = false;
                    cancelBtn.disabled      = false;
                    transmitBtn.textContent = 'Transmit';
                }
            });
        }

        // ============================================================
        // OFFER STATUS MESSAGE (inside modal, no redirect)
        // ============================================================
        function showOfferStatus(type, message) {
            const el = document.getElementById('offerStatusMsg');
            if (!el) return;
            el.style.display     = 'block';
            el.textContent       = message;
            el.style.background  = type === 'success' ? '#dcfce7' : '#fee2e2';
            el.style.color       = type === 'success' ? '#15803d'  : '#b91c1c';
            el.style.border      = type === 'success' ? '1px solid #86efac' : '1px solid #fca5a5';
        }

        function hideOfferStatus() {
            const el = document.getElementById('offerStatusMsg');
            if (el) el.style.display = 'none';
        }

        // ============================================================
        // MODAL OPEN / CLOSE
        // ============================================================
        function openOfferModal() {
            console.log('[ProposalDetails] openOfferModal ‚Üí opening');
            // Safety check: don't allow owner to open the offer modal
            if (currentUser && pitchData && currentUser.id === pitchData.user_id) {
                console.warn('[ProposalDetails] openOfferModal ‚Üí blocked: viewer is owner');
                alert('You cannot make an offer on your own proposal.');
                return;
            }
            hideOfferStatus();
            document.getElementById('offerModal').style.display = 'flex';
        }

        function closeOfferModal() {
            console.log('[ProposalDetails] closeOfferModal ‚Üí closing');
            document.getElementById('offerModal').style.display = 'none';
            hideOfferStatus();
            // Reset button state in case closed mid-submission
            const btn = document.getElementById('transmitBtn');
            if (btn) { btn.disabled = false; btn.textContent = 'Transmit'; }
            const cancel = document.getElementById('cancelOfferBtn');
            if (cancel) cancel.disabled = false;
        }

        // ============================================================
        // START CHAT
        // ============================================================
        async function startChat() {
            console.log('[ProposalDetails] startChat ‚Üí initiating chat with entrepreneur:', pitchData?.user_id);
            if (!currentUser || !pitchData) {
                console.error('[ProposalDetails] startChat ‚Üí missing currentUser or pitchData');
                return;
            }
            try {
                // Check if room already exists
                const { data: existingRoom, error: roomErr } = await supabase
                    .from('chat_rooms')
                    .select('id')
                    .eq('proposal_id', pitchId)
                    .eq('investor_id', currentUser.id)
                    .maybeSingle();

                if (roomErr) console.warn('[ProposalDetails] startChat ‚Üí room check error:', roomErr);

                if (existingRoom) {
                    console.log('[ProposalDetails] startChat ‚Üí existing room found:', existingRoom.id);
                    window.location.href = `chat.html?room=${existingRoom.id}`;
                    return;
                }

                console.log('[ProposalDetails] startChat ‚Üí creating new chat room...');
                const { data: newRoom, error: createErr } = await supabase
                    .from('chat_rooms')
                    .insert({
                        proposal_id:     pitchId,
                        entrepreneur_id: pitchData.user_id,
                        investor_id:     currentUser.id,
                        last_message:    'Audit Initiated'
                    })
                    .select()
                    .maybeSingle();

                if (createErr) {
                    console.error('[ProposalDetails] startChat ‚Üí room create error:', createErr);
                    alert('Error starting chat: ' + createErr.message);
                    return;
                }

                console.log('[ProposalDetails] startChat ‚Üí new room created:', newRoom.id);
                window.location.href = `chat.html?room=${newRoom.id}`;
            } catch (err) {
                console.error('[ProposalDetails] startChat ‚Üí ERROR:', err);
            }
        }

        // ============================================================
        // DELETE PITCH (owner action)
        // ============================================================
        async function deletePitch() {
            console.log('[ProposalDetails] deletePitch ‚Üí called for proposal:', pitchId);
            if (!confirm('Permanently purge this proposal? This cannot be undone.')) {
                console.log('[ProposalDetails] deletePitch ‚Üí cancelled by user');
                return;
            }
            try {
                const { error } = await supabase.from('proposals').delete().eq('id', pitchId);
                if (error) {
                    console.error('[ProposalDetails] deletePitch ‚Üí error:', error);
                    alert('Error deleting: ' + error.message);
                    return;
                }
                console.log('[ProposalDetails] deletePitch ‚Üí proposal deleted ‚úÖ, redirecting to dashboard');
                window.location.href = 'dashboard.html';
            } catch (err) {
                console.error('[ProposalDetails] deletePitch ‚Üí ERROR:', err);
            }
        }

        // ============================================================
        // BOOT
        // ============================================================
        window.onload = initAudit;
        console.log('[ProposalDetails] Script parsed, waiting for window.onload...');
    </script>
</body>
</html>
