<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Neural Handshake | Sovereign Hub</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@600;700;800&family=JetBrains+Mono:wght@500&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.min.js"></script>
    <link rel="stylesheet" href="css/dashboard.css">
    <style>
        :root {
            --shark-obsidian: #020617;
            --shark-indigo: #6366f1;
            --shark-bg: #f8fafc;
            --shark-border: #e2e8f0;
        }

        body {
            background-color: var(--shark-bg);
            height: 100vh; width: 100vw; margin: 0;
            display: flex; flex-direction: column; overflow: hidden;
            font-family: 'Plus Jakarta Sans', sans-serif;
        }

        /* NAV */
        .trinity-nav {
            background: var(--shark-obsidian);
            height: 80px; display: grid; grid-template-columns: 240px 1fr 240px;
            align-items: center; padding: 0 40px; border-bottom: 1px solid rgba(255,255,255,0.1);
            position: sticky; top: 0; z-index: 5000;
        }
        .nav-left  { display: flex; justify-content: flex-start; }
        .nav-center { display: flex; justify-content: center; }
        .nav-right  { display: flex; justify-content: flex-end; align-items: center; gap: 15px; }

        .btn-return {
            background: rgba(255,255,255,0.05); border: 1.5px solid rgba(255,255,255,0.1);
            color: #94a3b8; text-decoration: none; padding: 10px 20px; border-radius: 12px;
            font-size: 0.75rem; font-weight: 800; text-transform: uppercase; letter-spacing: 1px;
        }
        .central-statement {
            color: white; font-weight: 800; text-transform: uppercase; letter-spacing: 6px;
            font-size: 0.7rem; opacity: 0.6; text-align: center; white-space: nowrap;
        }

        /* ACCOUNT DROPDOWN */
        .account-dropdown {
            position: absolute; top: 60px; right: 0; width: 280px;
            background: white; border-radius: 25px; border: 1px solid var(--shark-border);
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.2);
            display: none; flex-direction: column; padding: 1.5rem; z-index: 6000;
            animation: dropdownPop 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }
        .account-dropdown.active { display: flex; }
        @keyframes dropdownPop { from { opacity:0; transform:translateY(10px) scale(0.95); } to { opacity:1; transform:translateY(0) scale(1); } }

        .drop-label { font-size: 0.55rem; font-weight: 800; color: #94a3b8; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 5px; display: block; }
        .drop-val   { font-size: 0.85rem; font-weight: 800; color: var(--shark-obsidian); margin-bottom: 15px; }
        .drop-link  { text-decoration: none; font-size: 0.75rem; font-weight: 800; color: var(--shark-indigo); display: flex; align-items: center; gap: 8px; padding: 10px 0; transition: 0.2s; }
        .drop-link:hover { transform: translateX(5px); }

        /* UNREAD BADGE */
        .unread-badge {
            background: var(--shark-indigo); color: white; font-size: 0.65rem; font-weight: 900;
            padding: 4px 10px; border-radius: 50px; box-shadow: 0 4px 12px rgba(99,102,241,0.4);
            animation: pulseBadge 2s infinite;
        }
        @keyframes pulseBadge { 0%,100% { transform:scale(1); } 70% { transform:scale(1.05); } }

        /* LAYOUT */
        .terminal-layout { display: flex; flex: 1; overflow: hidden; width: 100%; }
        .channel-sidebar {
            width: 380px; background: white; border-right: 1px solid var(--shark-border);
            display: flex; flex-direction: column; padding: 2rem; overflow-y: auto;
        }
        .room-card {
            background: white; border-radius: 20px; padding: 1.2rem; margin-bottom: 0.8rem;
            border: 1px solid var(--shark-border); display: flex; gap: 15px; align-items: center;
            cursor: pointer; transition: 0.3s;
        }
        .room-card:hover  { border-color: var(--shark-indigo); background: #fafafa; }
        .room-card.active { background: #f5f3ff; border-color: var(--shark-indigo); }

        /* CHAT CONSOLE */
        .chat-console { flex: 1; display: flex; flex-direction: column; background: white; overflow: hidden; }
        .chat-header-bar {
            height: 90px; padding: 0 3.5rem; border-bottom: 1px solid var(--shark-border);
            display: flex; align-items: center; justify-content: space-between; cursor: pointer;
        }
        .msg-scroll  { flex: 1; overflow-y: auto; padding: 2rem 3.5rem; display: flex; flex-direction: column; gap: 10px; scroll-behavior: smooth; }

        .bubble { max-width: 65%; padding: 1.1rem 1.4rem; border-radius: 25px; font-size: 0.95rem; line-height: 1.5; position: relative; }
        .sent     { align-self: flex-end; background: var(--shark-indigo); color: white; border-bottom-right-radius: 4px; }
        .received { align-self: flex-start; background: #f8fafc; border: 1px solid var(--shark-border); border-bottom-left-radius: 4px; }

        .input-bar { height: 110px; padding: 0 3.5rem; border-top: 1px solid var(--shark-border); display: flex; align-items: center; }
        .glass-input {
            width: 100%; background: #f8fafc; border: 2px solid var(--shark-border);
            border-radius: 50px; padding: 10px 30px; display: flex; align-items: center; gap: 15px;
        }
        .glass-input input { flex: 1; border: none; background: transparent; font-size: 1rem; outline: none; }
        .glass-input:focus-within { border-color: var(--shark-indigo); }

        /* PARTNER MODAL */
        .modal-overlay {
            position: fixed; inset: 0; background: rgba(2,6,23,0.8);
            backdrop-filter: blur(12px); z-index: 9000;
            display: none; align-items: center; justify-content: center;
        }
        .forensic-modal {
            background: white; width: 90%; max-width: 450px; border-radius: 45px;
            padding: 3.5rem; text-align: center; border: 1px solid var(--shark-border);
            box-shadow: 0 50px 100px rgba(0,0,0,0.3); animation: dropdownPop 0.4s ease;
        }
        .modal-avatar {
            width: 80px; height: 80px; border-radius: 50%; background: var(--shark-obsidian);
            color: white; display: flex; align-items: center; justify-content: center;
            font-size: 2rem; font-weight: 900; margin: 0 auto 1.5rem;
        }

        /* SEND ERROR TOAST */
        #sendError {
            display: none; position: absolute; bottom: 120px; left: 50%;
            transform: translateX(-50%); background: #fee2e2; color: #b91c1c;
            padding: 10px 20px; border-radius: 12px; font-size: 0.78rem; font-weight: 700;
            border: 1px solid #fca5a5; white-space: nowrap; z-index: 100;
        }

        .hidden { display: none !important; }
    </style>
</head>
<body>

    <nav class="trinity-nav">
        <div class="nav-left">
            <a href="dashboard.html" class="btn-return">‚Üê Hub Terminal</a>
        </div>
        <div class="nav-center"><h2 class="central-statement">Money can't buy happiness, isn't it?</h2></div>
        <div class="nav-right">
            <div id="liveClock" style="font-family:'JetBrains Mono'; color:#4ade80; font-weight:800; font-size:0.9rem; margin-right:10px;">00:00:00</div>
            <div id="userWrapper" style="position:relative;">
                <div onclick="toggleAccountMenu(event)" style="width:34px; height:34px; border-radius:50%; background:var(--shark-indigo); color:white; display:flex; align-items:center; justify-content:center; font-weight:900; cursor:pointer;" id="myAvatar">?</div>
                <div id="accountDropdown" class="account-dropdown">
                    <span class="drop-label">Handshake Identity</span>
                    <div class="drop-val" id="dropName">-</div>
                    <span class="drop-label">System Role</span>
                    <div class="drop-val" id="dropRole" style="color:var(--shark-indigo);">-</div>
                    <div style="height:1px; background:#f1f5f9; margin:10px 0 15px;"></div>
                    <a href="profile.html" class="drop-link">‚öôÔ∏è Refine Profile</a>
                    <a href="#" id="myPublicLink" class="drop-link">üë§ View Public Manifest</a>
                    <div style="height:1px; background:#f1f5f9; margin:10px 0 15px;"></div>
                    <button onclick="handleLogout()" style="background:#fef2f2; color:#ef4444; border:none; padding:12px; border-radius:12px; font-weight:900; font-size:0.65rem; text-transform:uppercase; cursor:pointer; width:100%;">üî¥ Terminate Session</button>
                </div>
            </div>
        </div>
    </nav>

    <main class="terminal-layout">
        <aside class="channel-sidebar">
            <span style="font-size:0.7rem; font-weight:900; color:var(--shark-indigo); letter-spacing:3px; margin-bottom:2rem; display:block;">FORENSIC_NODES</span>
            <div id="roomList"></div>
        </aside>

        <section class="chat-console" style="position:relative;">
            <div id="noChatSelected" style="flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center; opacity:0.1; text-align:center;">
                <h1 style="font-size:5rem; font-weight:900; letter-spacing:-4px; margin:0; color:var(--shark-obsidian);">SOVEREIGN</h1>
                <p style="font-weight:800; text-transform:uppercase;">Initialize Link</p>
            </div>

            <div id="chatWindow" class="hidden" style="display:flex; flex-direction:column; height:100%;">
                <div class="chat-header-bar" onclick="openPartnerAudit()">
                    <div style="display:flex; align-items:center; gap:15px;">
                        <div id="headerAvatar" style="width:45px; height:45px; background:var(--shark-obsidian); border-radius:50%; display:flex; align-items:center; justify-content:center; color:white; font-weight:800; font-size:1.1rem;">?</div>
                        <div>
                            <span id="headerPitch" style="font-size:0.6rem; color:var(--shark-indigo); font-weight:900; display:block; text-transform:uppercase;">ASSET REF</span>
                            <h2 id="headerPartner" style="margin:0; font-size:1.5rem; font-weight:900; letter-spacing:-1px; color:var(--shark-obsidian);">Partner Name</h2>
                        </div>
                    </div>
                    <span style="font-size:0.6rem; font-weight:800; color:#94a3b8; letter-spacing:1px;">AUDIT_PARTNER ‚Üí</span>
                </div>

                <div class="msg-scroll" id="msgBox"></div>

                <!-- Send error toast (shown inline above input bar) -->
                <div id="sendError"></div>

                <form class="input-bar" id="chatForm">
                    <div class="glass-input">
                        <input type="text" id="msgInput" placeholder="Transmit secure message..." autocomplete="off">
                        <button type="submit" id="sendBtn" style="background:var(--shark-indigo); color:white; border:none; padding:10px 25px; border-radius:30px; font-size:0.75rem; font-weight:800; cursor:pointer; transition:.2s;">SEND</button>
                    </div>
                </form>
            </div>
        </section>
    </main>

    <!-- PARTNER AUDIT MODAL -->
    <div id="partnerModal" class="modal-overlay" onclick="closePartnerAudit()">
        <div class="forensic-modal" onclick="event.stopPropagation()">
            <div class="modal-avatar" id="pModalAvatar">?</div>
            <h2 id="pModalName" style="font-size:2rem; font-weight:900; letter-spacing:-1px; margin:0;">Partner Name</h2>
            <p id="pModalRole" style="color:var(--shark-indigo); font-weight:900; text-transform:uppercase; font-size:0.7rem; letter-spacing:2px; margin:10px 0 25px;"></p>
            <div style="text-align:left; background:#f8fafc; padding:20px; border-radius:20px; border:1px solid var(--shark-border); margin-bottom:2rem;">
                <span class="drop-label">Negotiation Context</span>
                <div id="pModalPitch" style="font-weight:800; font-size:1rem; color:var(--shark-obsidian);">Loading...</div>
            </div>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
                <button onclick="closePartnerAudit()" style="background:#f1f5f9; color:var(--shark-obsidian); border:none; padding:15px; border-radius:18px; font-weight:800; font-size:0.75rem; cursor:pointer;">CLOSE</button>
                <a id="pModalLink" href="#" style="background:var(--shark-obsidian); color:white; text-decoration:none; padding:15px; border-radius:18px; font-weight:800; font-size:0.75rem; display:flex; align-items:center; justify-content:center;">VIEW_MANIFEST</a>
            </div>
        </div>
    </div>

    <script src="js/config.js"></script>
    <script src="js/utils.js"></script>
    <script>
        console.log('[Chat] Script initializing...');

        let me              = null;
        let myRole          = null;
        let activeRoomId    = null;
        let activePartnerData = null;
        let activeRoomData  = null;
        let activeSubscription = null;
        let isSending       = false; // debounce flag

        // ============================================================
        // UI TOGGLES
        // ============================================================
        function toggleAccountMenu(e) {
            e.stopPropagation();
            document.getElementById('accountDropdown').classList.toggle('active');
        }

        document.addEventListener('click', () => {
            const dd = document.getElementById('accountDropdown');
            if (dd) dd.classList.remove('active');
        });

        function openPartnerAudit() {
            if (!activePartnerData) {
                console.warn('[Chat] openPartnerAudit ‚Üí no activePartnerData');
                return;
            }
            const name = activePartnerData.full_name || 'Unknown';
            const role = activePartnerData.role || '‚Äî';
            document.getElementById('pModalAvatar').textContent = name.charAt(0).toUpperCase();
            document.getElementById('pModalName').textContent   = name;
            document.getElementById('pModalRole').textContent   = role.toUpperCase();
            document.getElementById('pModalPitch').textContent  = activeRoomData?.proposals?.title || 'Direct Support Inquiry';
            document.getElementById('pModalLink').href          = `user-profile.html?id=${activePartnerData.id}`;
            document.getElementById('partnerModal').style.display = 'flex';
        }

        function closePartnerAudit() {
            document.getElementById('partnerModal').style.display = 'none';
        }

        // ============================================================
        // INIT
        // ============================================================
        async function init() {
            console.log('[Chat] init ‚Üí starting...');

            const { data: { user }, error: authErr } = await supabase.auth.getUser();
            if (authErr) { console.error('[Chat] auth error:', authErr); window.location.replace('auth.html'); return; }
            if (!user)   { console.warn('[Chat] no session');            window.location.replace('auth.html'); return; }
            me = user.id;
            console.log('[Chat] init ‚Üí authenticated:', me);

            // Fetch own profile
            const { data: profile, error: profErr } = await supabase
                .from('users').select('*').eq('id', me).maybeSingle();

            if (profErr) {
                console.error('[Chat] init ‚Üí profile fetch error:', profErr);
                // Non-fatal ‚Äî still allow chat with default values
            }
            if (!profile) {
                console.warn('[Chat] init ‚Üí profile not found for user:', me);
            }

            myRole = profile?.role || 'entrepreneur';
            const displayName = profile?.full_name || 'User';

            document.getElementById('myAvatar').textContent    = displayName.charAt(0).toUpperCase();
            document.getElementById('dropName').textContent    = displayName;
            document.getElementById('dropRole').textContent    = myRole.toUpperCase();
            document.getElementById('myPublicLink').href       = `user-profile.html?id=${me}`;
            console.log('[Chat] init ‚Üí profile loaded:', displayName, '| role:', myRole);

            await loadRooms();
            setupGlobalRealtime();

            // Auto-open room from URL param
            const urlRoom = new URLSearchParams(window.location.search).get('room');
            if (urlRoom) {
                console.log('[Chat] init ‚Üí auto-opening room from URL:', urlRoom);
                await openRoom(urlRoom);
            }

            // Clock
            setInterval(() => {
                const el = document.getElementById('liveClock');
                if (el) el.textContent = new Date().toLocaleTimeString('en-US', { hour12: false });
            }, 1000);

            console.log('[Chat] init ‚Üí fully loaded ‚úÖ');
        }

        // ============================================================
        // REALTIME ‚Äî global channel to update room list when new messages arrive
        // ============================================================
        function setupGlobalRealtime() {
            console.log('[Chat] setupGlobalRealtime ‚Üí subscribing...');
            supabase.channel('global-chat')
                .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages' }, async (payload) => {
                    console.log('[Chat] realtime ‚Üí new message in room:', payload.new.room_id, '| active room:', activeRoomId);
                    if (payload.new.room_id !== activeRoomId) {
                        // Message in a different room ‚Äî refresh sidebar to update unread count
                        await loadRooms();
                    }
                }).subscribe((status) => {
                    console.log('[Chat] global realtime status:', status);
                });
        }

        // ============================================================
        // LOAD ROOMS ‚Äî renders sidebar list
        // ============================================================
        async function loadRooms() {
            console.log('[Chat] loadRooms ‚Üí fetching rooms for user:', me);

            const { data: rooms, error } = await supabase
                .from('chat_rooms')
                .select('*, proposals(title), entrepreneur:entrepreneur_id(full_name), investor:investor_id(full_name)')
                .or(`entrepreneur_id.eq.${me},investor_id.eq.${me}`)
                .order('updated_at', { ascending: false });

            if (error) {
                console.error('[Chat] loadRooms ‚Üí fetch error:', error);
                return;
            }
            console.log('[Chat] loadRooms ‚Üí', rooms?.length ?? 0, 'rooms found');

            const list = document.getElementById('roomList');
            if (!list) return;

            if (!rooms || rooms.length === 0) {
                list.innerHTML = '<p style="font-size:.8rem;color:#94a3b8;font-weight:700;text-align:center;padding:2rem 0;">No channels yet</p>';
                return;
            }

            list.innerHTML = rooms.map(r => {
                // ‚îÄ‚îÄ NULL GUARD: if either participant was deleted, fall back gracefully ‚îÄ‚îÄ
                const isEntrepreneur = me === r.entrepreneur_id;
                const partnerObj     = isEntrepreneur ? r.investor : r.entrepreneur;
                const partnerName    = partnerObj?.full_name || 'Deleted User';
                const partnerInitial = partnerName.charAt(0).toUpperCase();

                // Unread count based on own role
                const unread = myRole === 'entrepreneur'
                    ? (r.unread_count_entrepreneur || 0)
                    : (r.unread_count_investor || 0);

                const displayTitle = r.proposals?.title || 'OVERSIGHT_SUPPORT';

                if (!partnerObj) {
                    console.warn('[Chat] loadRooms ‚Üí room', r.id, 'has deleted participant (', isEntrepreneur ? 'investor' : 'entrepreneur', ')');
                }

                return `
                    <div class="room-card ${activeRoomId === r.id ? 'active' : ''}" onclick="openRoom('${r.id}')">
                        <div style="width:40px; height:40px; border-radius:50%; background:var(--shark-bg); color:var(--shark-indigo); border:1px solid var(--shark-border); display:flex; align-items:center; justify-content:center; font-weight:800; flex-shrink:0;">
                            ${partnerInitial}
                        </div>
                        <div style="flex:1; overflow:hidden;">
                            <span style="font-size:0.5rem; color:var(--shark-indigo); font-weight:900; text-transform:uppercase; display:block; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">
                                ${displayTitle}
                            </span>
                            <div style="font-weight:800; font-size:0.9rem; color:var(--shark-obsidian); white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">
                                ${partnerName}
                            </div>
                            ${r.last_message ? `<div style="font-size:0.72rem;color:#94a3b8;margin-top:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${r.last_message.substring(0,40)}${r.last_message.length>40?'‚Ä¶':''}</div>` : ''}
                        </div>
                        ${unread > 0 ? `<span class="unread-badge">${unread}</span>` : ''}
                    </div>`;
            }).join('');
        }

        // ============================================================
        // OPEN ROOM ‚Äî load messages and subscribe to realtime
        // ============================================================
        async function openRoom(id) {
            console.log('[Chat] openRoom ‚Üí id:', id);

            // Unsubscribe from previous room channel
            if (activeSubscription) {
                console.log('[Chat] openRoom ‚Üí removing previous subscription');
                supabase.removeChannel(activeSubscription);
                activeSubscription = null;
            }

            activeRoomId = id;

            // Show chat window
            const noChatEl  = document.getElementById('noChatSelected');
            const chatWinEl = document.getElementById('chatWindow');
            if (noChatEl)  noChatEl.classList.add('hidden');
            if (chatWinEl) {
                chatWinEl.classList.remove('hidden');
                chatWinEl.style.display = 'flex';
            }

            const box = document.getElementById('msgBox');
            if (box) box.innerHTML = '<div style="text-align:center;padding:2rem;opacity:.3;font-size:.8rem;font-weight:700;">Loading messages...</div>';

            // Fetch room with full participant data
            console.log('[Chat] openRoom ‚Üí fetching room data...');
            const { data: room, error: roomErr } = await supabase
                .from('chat_rooms')
                .select('*, proposals(title), entrepreneur:entrepreneur_id(*), investor:investor_id(*)')
                .eq('id', id)
                .maybeSingle();

            if (roomErr) {
                console.error('[Chat] openRoom ‚Üí room fetch error:', roomErr);
                if (box) box.innerHTML = '<div style="text-align:center;padding:2rem;color:#ef4444;font-weight:700;">Failed to load room. Please try again.</div>';
                return;
            }
            if (!room) {
                console.error('[Chat] openRoom ‚Üí room not found:', id);
                if (box) box.innerHTML = '<div style="text-align:center;padding:2rem;color:#ef4444;font-weight:700;">Room not found.</div>';
                return;
            }

            activeRoomData = room;

            // ‚îÄ‚îÄ NULL GUARD: determine partner safely ‚îÄ‚îÄ
            const isEntrepreneur = me === room.entrepreneur_id;
            const partnerObj     = isEntrepreneur ? room.investor : room.entrepreneur;
            activePartnerData    = partnerObj || null;

            if (!partnerObj) {
                console.warn('[Chat] openRoom ‚Üí partner data missing (deleted user?) ‚Äî room:', id);
            }

            const partnerName    = partnerObj?.full_name || 'Deleted User';
            const partnerInitial = partnerName.charAt(0).toUpperCase();
            const pitchTitle     = room.proposals?.title || 'OVERSIGHT_SUPPORT';

            console.log('[Chat] openRoom ‚Üí partner:', partnerName, '| proposal:', pitchTitle);

            // Update header
            const headerPartner = document.getElementById('headerPartner');
            const headerAvatar  = document.getElementById('headerAvatar');
            const headerPitch   = document.getElementById('headerPitch');
            if (headerPartner) headerPartner.textContent = partnerName;
            if (headerAvatar)  headerAvatar.textContent  = partnerInitial;
            if (headerPitch)   headerPitch.textContent   = pitchTitle;

            // Load messages
            console.log('[Chat] openRoom ‚Üí fetching messages...');
            const { data: msgs, error: msgsErr } = await supabase
                .from('messages')
                .select('*')
                .eq('room_id', id)
                .order('created_at', { ascending: true });

            if (msgsErr) {
                console.error('[Chat] openRoom ‚Üí messages fetch error:', msgsErr);
                if (box) box.innerHTML = '<div style="text-align:center;padding:2rem;color:#ef4444;font-weight:700;">Failed to load messages.</div>';
                return;
            }

            if (box) {
                box.innerHTML = '';
                if (!msgs || msgs.length === 0) {
                    box.innerHTML = '<div style="text-align:center;padding:4rem;opacity:.3;font-size:.8rem;font-weight:700;">No messages yet. Say something.</div>';
                } else {
                    msgs.forEach(m => appendMessage(m));
                    box.scrollTop = box.scrollHeight;
                }
            }
            console.log('[Chat] openRoom ‚Üí', msgs?.length ?? 0, 'messages loaded');

            // Mark as read
            const readField = myRole === 'entrepreneur' ? 'unread_count_entrepreneur' : 'unread_count_investor';
            const { error: readErr } = await supabase
                .from('chat_rooms')
                .update({ [readField]: 0 })
                .eq('id', id);
            if (readErr) console.warn('[Chat] openRoom ‚Üí mark read error:', readErr);

            // Refresh sidebar to update unread badge
            await loadRooms();

            // Subscribe to new messages in this room
            console.log('[Chat] openRoom ‚Üí subscribing to room channel...');
            activeSubscription = supabase.channel(`room-${id}`)
                .on('postgres_changes', {
                    event: 'INSERT', schema: 'public', table: 'messages',
                    filter: `room_id=eq.${id}`
                }, (payload) => {
                    console.log('[Chat] realtime ‚Üí new message received in active room');
                    appendMessage(payload.new);
                    if (box) box.scrollTop = box.scrollHeight;
                })
                .subscribe((status) => {
                    console.log('[Chat] room subscription status:', status);
                });
        }

        // ============================================================
        // APPEND MESSAGE ‚Äî renders a single bubble
        // ============================================================
        function appendMessage(m) {
            const box = document.getElementById('msgBox');
            if (!box) return;

            // Remove empty-state placeholder if present
            const emptyState = box.querySelector('[data-empty]');
            if (emptyState) emptyState.remove();

            const isMe = m.sender_id === me;
            const time = m.created_at
                ? new Date(m.created_at).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: false })
                : '';

            // Escape content to prevent XSS
            const safe = (str) => str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');

            box.insertAdjacentHTML('beforeend', `
                <div style="display:flex; flex-direction:column; width:100%; margin-bottom:10px;">
                    <div class="bubble ${isMe ? 'sent' : 'received'}">
                        ${safe(m.content || '')}
                        <span style="font-family:'JetBrains Mono'; font-size:0.55rem; opacity:0.5; display:block; margin-top:5px; text-align:right;">${time}</span>
                    </div>
                </div>`);
        }

        // ============================================================
        // SEND MESSAGE ‚Äî with error handling and debounce
        // ============================================================
        document.getElementById('chatForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const input   = document.getElementById('msgInput');
            const sendBtn = document.getElementById('sendBtn');
            const content = input?.value?.trim();

            if (!content) return;
            if (!activeRoomId) {
                console.warn('[Chat] send ‚Üí no active room selected');
                return;
            }
            if (isSending) {
                console.warn('[Chat] send ‚Üí already sending, ignoring duplicate submit');
                return;
            }

            console.log('[Chat] send ‚Üí room:', activeRoomId, '| length:', content.length);

            isSending = true;
            if (sendBtn) { sendBtn.disabled = true; sendBtn.textContent = '...'; }
            if (input)     input.value = '';
            hideSendError();

            // STEP 1: Insert message
            const { data: newMsg, error: msgErr } = await supabase
                .from('messages')
                .insert({ room_id: activeRoomId, sender_id: me, content })
                .select()
                .maybeSingle();

            if (msgErr) {
                console.error('[Chat] send ‚Üí message insert error:', msgErr);
                showSendError('Message failed to send. Please try again.');
                if (input) input.value = content; // restore unsent message
                isSending = false;
                if (sendBtn) { sendBtn.disabled = false; sendBtn.textContent = 'SEND'; }
                return;
            }
            console.log('[Chat] send ‚Üí message inserted ‚úÖ | id:', newMsg?.id);

            // STEP 2: Update room metadata (last_message + unread count)
            // Increment unread for the OTHER person, not the sender
            const unreadField = myRole === 'entrepreneur' ? 'unread_count_investor' : 'unread_count_entrepreneur';

            // Fetch current unread count first
            const { data: currentRoom, error: fetchErr } = await supabase
                .from('chat_rooms')
                .select(unreadField)
                .eq('id', activeRoomId)
                .maybeSingle();

            if (fetchErr) {
                console.warn('[Chat] send ‚Üí room fetch for unread error:', fetchErr);
                // Non-fatal ‚Äî message is sent, just unread count won't increment
            }

            const currentUnread = currentRoom?.[unreadField] || 0;
            const { error: roomUpdateErr } = await supabase
                .from('chat_rooms')
                .update({
                    last_message: content,
                    updated_at:   new Date().toISOString(),
                    [unreadField]: currentUnread + 1
                })
                .eq('id', activeRoomId);

            if (roomUpdateErr) {
                console.warn('[Chat] send ‚Üí room update error (non-fatal):', roomUpdateErr);
            } else {
                console.log('[Chat] send ‚Üí room metadata updated ‚úÖ');
            }

            // STEP 3: Notify the other party about the new message
            // Determine recipient ‚Äî opposite of sender role
            const recipientId = myRole === 'entrepreneur'
                ? activeRoomData?.investor_id
                : activeRoomData?.entrepreneur_id;

            if (recipientId) {
                console.log('[Chat] send ‚Üí notifying recipient:', recipientId);
                const proposalTitle = activeRoomData?.proposals?.title || 'your conversation';
                const { error: notifErr } = await supabase.from('notifications').insert({
                    user_id: recipientId,
                    title:   'üí¨ New Message',
                    message: `You have a new message regarding "${proposalTitle}".`,
                    type:    'message',
                    link:    `chat.html?room=${activeRoomId}`
                });
                if (notifErr) console.warn('[Chat] send ‚Üí notification failed (non-fatal):', notifErr);
                else console.log('[Chat] send ‚Üí recipient notified ‚úÖ');
            } else {
                console.warn('[Chat] send ‚Üí could not determine recipient ID for notification');
            }

            isSending = false;
            if (sendBtn) { sendBtn.disabled = false; sendBtn.textContent = 'SEND'; }
        });

        // ============================================================
        // SEND ERROR TOAST
        // ============================================================
        function showSendError(msg) {
            const el = document.getElementById('sendError');
            if (!el) return;
            el.textContent  = msg;
            el.style.display = 'block';
            setTimeout(() => hideSendError(), 4000);
        }

        function hideSendError() {
            const el = document.getElementById('sendError');
            if (el) el.style.display = 'none';
        }

        // ============================================================
        // BOOT
        // ============================================================
        window.onload = init;
        console.log('[Chat] Script parsed, waiting for window.onload...');
    </script>
</body>
</html>