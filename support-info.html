<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Support Manifest | Sovereign Hub</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.min.js"></script>
    <link rel="stylesheet" href="css/dashboard.css">
    <style>
        /* --- 1. CONTROL BAR & HEADER --- */
        .trinity-nav {
            position: fixed; top: 0; left: 0; width: 100%; height: 80px;
            background: rgba(2, 6, 23, 0.98); backdrop-filter: blur(20px);
            z-index: 10000; border-bottom: 1px solid rgba(255,255,255,0.1);
            display: flex; justify-content: space-between; align-items: center; padding: 0 50px;
        }

        .back-btn-box {
            background: rgba(255, 255, 255, 0.05); border: 1.5px solid rgba(255,255,255,0.1);
            padding: 12px 24px; border-radius: 14px; color: #94a3b8; text-decoration: none;
            font-weight: 800; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1.5px;
            transition: 0.4s; display: flex; align-items: center; gap: 10px;
        }
        .back-btn-box:hover { background: var(--shark-indigo); color: white; transform: translateX(-5px); }

        .support-header { 
            background: var(--shark-obsidian); 
            background-image: radial-gradient(circle at 50% 100%, rgba(99,102,241,0.15) 0%, transparent 50%);
            padding: 180px 0 140px; text-align: center; color: white; border-radius: 0 0 100px 100px;
        }

        /* --- 2. CENTERED FOCUS LAYOUT --- */
        .support-layout {
            max-width: 1440px; margin: -80px auto 100px;
            display: grid; grid-template-columns: 350px 1fr 350px; gap: 30px; padding: 0 40px;
        }

        .info-card { background: white; border-radius: 40px; padding: 35px; border: 1px solid var(--shark-border); box-shadow: 0 40px 80px rgba(0,0,0,0.03); height: fit-content; }
        .f-label { font-size: 0.6rem; font-weight: 900; color: var(--shark-indigo); text-transform: uppercase; letter-spacing: 2px; display: block; margin-bottom: 20px; border-bottom: 1px solid #f1f5f9; padding-bottom: 10px; }

        /* --- 3. TICKET BUFFER (CENTER) --- */
        .ticket-list-container { background: white; border-radius: 50px; padding: 50px; border: 1px solid var(--shark-border); box-shadow: 0 50px 100px rgba(0,0,0,0.04); }
        
        .ticket-box { 
            background: #f8fafc; border-radius: 25px; padding: 30px; border: 1px solid var(--shark-border); 
            margin-bottom: 20px; transition: 0.3s cubic-bezier(0.16, 1, 0.3, 1); cursor: pointer;
        }
        .ticket-box:hover { transform: scale(1.02); border-color: var(--shark-indigo); background: white; box-shadow: 0 20px 40px rgba(0,0,0,0.05); }

        .status-pill { font-size: 0.55rem; font-weight: 900; text-transform: uppercase; padding: 4px 10px; border-radius: 6px; display: inline-block; margin-bottom: 10px; }
        .st-pending { background: #fffbeb; color: #d97706; }
        .st-review { background: #eef2ff; color: #4f46e5; }
        .st-resolved { background: #ecfdf5; color: #059669; }

        /* --- 4. FORENSIC MODAL --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(2, 6, 23, 0.85); backdrop-filter: blur(12px);
            z-index: 20000; display: none; align-items: center; justify-content: center; padding: 20px;
        }
        .forensic-modal {
            background: white; width: 100%; max-width: 650px; border-radius: 45px;
            padding: 50px; position: relative; box-shadow: 0 50px 100px rgba(0,0,0,0.4);
            animation: modalSlide 0.4s ease-out;
        }
        @keyframes modalSlide { from { opacity: 0; transform: translateY(40px); } to { opacity: 1; transform: translateY(0); } }
        
        .modal-close { position: absolute; top: 30px; right: 30px; cursor: pointer; font-weight: 900; color: #94a3b8; font-size: 0.75rem; border: 1.5px solid #e2e8f0; padding: 6px 16px; border-radius: 50px; }

        .stream-node { background: #f8fafc; padding: 25px; border-radius: 20px; border: 1px solid var(--shark-border); margin-top: 25px; }
        .stream-node.admin { border-left: 6px solid var(--shark-emerald); background: #f0fdf4; margin-top: 15px; }
        .stream-label { font-size: 0.6rem; font-weight: 900; color: #94a3b8; text-transform: uppercase; letter-spacing: 1px; display: block; margin-bottom: 10px; }
        .stream-content { font-size: 1rem; line-height: 1.6; color: var(--shark-obsidian); font-weight: 600; }

        #liveClock { font-family: 'JetBrains Mono'; color: #4ade80; font-weight: 900; }
    </style>
</head>
<body>

    <!-- TRINITY NAV -->
    <nav class="trinity-nav">
        <div class="nav-left">
            <a href="dashboard.html" class="back-btn-box">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
                Exit Hub
            </a>
        </div>
        <div class="nav-center">
            <h2 class="central-statement" style="border:none; letter-spacing: 6px; opacity: 0.5;">SUPPORT_MANIFEST_v4</h2>
        </div>
        <div class="nav-right"><div id="liveClock">00:00:00</div></div>
    </nav>

    <header class="support-header">
        <span style="font-size: 0.75rem; font-weight: 900; letter-spacing: 5px; color: var(--shark-indigo); text-transform: uppercase;">Central Oversight Assistance</span>
        <h1 style="font-size: 5rem; font-weight: 900; letter-spacing: -4px; margin: 10px 0; line-height: 1;">Help Desk</h1>
        <p style="opacity: 0.5; font-size: 1.1rem; font-weight: 500;">Forensic inquiry tracking and syndicate directives.</p>
    </header>

    <main class="support-layout">
        
        <!-- SIDEBAR LEFT: SYSTEM STATS -->
        <aside>
            <div class="info-card" style="background: var(--shark-obsidian); color: white; margin-bottom: 25px;">
                <span class="f-label" style="color:rgba(255,255,255,0.3); border-bottom-color:rgba(255,255,255,0.1);">Health Matrix</span>
                <div style="display:flex; justify-content:space-between; font-family:'JetBrains Mono'; font-size:0.65rem; margin-bottom:12px;">
                    <span>SYNDICATE_LINK</span> <span style="color:#4ade80">ONLINE</span>
                </div>
                <div style="display:flex; justify-content:space-between; font-family:'JetBrains Mono'; font-size:0.65rem;">
                    <span>LEDGER_SYNC</span> <span style="color:#4ade80">STABLE</span>
                </div>
            </div>

            <div class="info-card">
                <span class="f-label">Resolution Ethics</span>
                <p style="font-size: 0.85rem; color: var(--shark-muted); line-height: 1.7;">
                    Every inquiry is audited manually. We prioritize financial discrepancies and verification issues. Response window is typically 12-24 hours.
                </p>
            </div>
        </aside>

        <!-- CENTER: ACTIVE TICKETS -->
        <section class="ticket-list-container">
            <span class="f-label">Active Inquiry Buffer</span>
            <div id="userTicketsContainer">
                <p style="text-align:center; opacity:0.3; padding: 4rem; font-weight: 800;">SCANNING_FOR_LOGS...</p>
            </div>
            <div style="text-align: center; margin-top: 30px;">
                <p style="font-size: 0.8rem; color: var(--shark-muted);">Need more help? Use the support node on your dashboard.</p>
            </div>
        </section>

        <!-- SIDEBAR RIGHT: FAQ -->
        <aside>
            <div class="info-card">
                <span class="f-label">System Directives</span>
                <div style="margin-bottom: 25px;">
                    <h4 style="font-weight: 800; font-size: 0.95rem; margin-bottom: 5px;">Success Score Logic</h4>
                    <p style="font-size: 0.8rem; color: var(--shark-muted);">Calculated based on milestones achieved (40%), funding status (30%), and operational time (30%).</p>
                </div>
                <div>
                    <h4 style="font-weight: 800; font-size: 0.95rem; margin-bottom: 5px;">Verification Time</h4>
                    <p style="font-size: 0.8rem; color: var(--shark-muted);">New entities and assets require a 24-hour forensic window for global marketplace listing.</p>
                </div>
            </div>
        </aside>

    </main>

    <!-- THE FORENSIC DETAIL MODAL (Popup of User Submission & Admin Note) -->
    <div id="detailModal" class="modal-overlay" onclick="closeDetailModal()">
        <div class="forensic-modal" onclick="event.stopPropagation()">
            <div class="modal-close" onclick="closeDetailModal()">CLOSE_TERMINAL</div>
            <span class="f-label">Inquiry Case File</span>
            <h2 id="modalSubject" style="font-size: 2.2rem; font-weight: 900; letter-spacing: -1.5px; margin: 10px 0 5px;">Subject</h2>
            <div id="modalStatus" style="margin-bottom: 10px;"></div>

            <div class="data-stream">
                <div class="stream-node">
                    <span class="stream-label">User Transmission (Original Message)</span>
                    <div id="modalUserMsg" class="stream-content">-</div>
                </div>

                <div class="stream-node admin" id="adminNode">
                    <span class="stream-label">Syndicate Directive (Admin Response)</span>
                    <div id="modalAdminMsg" class="stream-content" style="font-style: italic;">Awaiting officer directive...</div>
                </div>
            </div>
        </div>
    </div>

    <script src="js/config.js"></script>
    <script>
        let allMyTickets = [];

        function updateClock() { document.getElementById('liveClock').textContent = new Date().toLocaleTimeString('en-US', { hour12: false }); }
        setInterval(updateClock, 1000); updateClock();

        async function loadTickets() {
            try {
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) return window.location.href = 'auth.html';

                const { data: tickets, error } = await supabase
                    .from('support_inquiries')
                    .select('*')
                    .eq('user_id', user.id)
                    .order('created_at', { ascending: false });

                if (error) throw error;
                allMyTickets = tickets;

                const container = document.getElementById('userTicketsContainer');
                if (!tickets?.length) {
                    container.innerHTML = "<p style='text-align:center; opacity:0.3; padding:4rem; font-weight:800;'>NO_ACTIVE_RECORDS</p>";
                    return;
                }

                container.innerHTML = tickets.map(t => {
                    let statusClass = t.status === 'pending' ? 'st-pending' : (t.status === 'under_review' ? 'st-review' : 'st-resolved');
                    return `
                        <div class="ticket-box" onclick="openDetailModal('${t.id}')">
                            <div style="display:flex; justify-content:space-between; align-items:start;">
                                <span class="status-pill ${statusClass}">${t.status.replace('_', ' ')}</span>
                                <span style="font-family:'JetBrains Mono'; font-size:0.6rem; color:#94a3b8;">${new Date(t.created_at).toLocaleDateString()}</span>
                            </div>
                            <div style="font-weight: 900; font-size: 1.2rem; letter-spacing: -0.5px; margin-top:5px;">${t.subject}</div>
                            <p style="font-size:0.85rem; color:var(--shark-muted); margin-top:10px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${t.message}</p>
                            <span style="font-family:'JetBrains Mono'; font-size:0.55rem; color:var(--shark-indigo); display:block; margin-top:15px; opacity:0.6;">UUID: ${t.id}</span>
                        </div>
                    `;
                }).join('');
            } catch (err) { console.error("Sync Error:", err); }
        }

        function openDetailModal(id) {
            const ticket = allMyTickets.find(t => t.id === id);
            if (!ticket) return;

            document.getElementById('modalSubject').textContent = ticket.subject;
            document.getElementById('modalUserMsg').textContent = ticket.message;
            
            const statusEl = document.getElementById('modalStatus');
            let statusClass = ticket.status === 'pending' ? 'st-pending' : (ticket.status === 'under_review' ? 'st-review' : 'st-resolved');
            statusEl.innerHTML = `<span class="status-pill ${statusClass}">${ticket.status.replace('_', ' ')}</span>`;

            const adminMsgEl = document.getElementById('modalAdminMsg');
            const adminNode = document.getElementById('adminNode');
            
            if (ticket.admin_notes) {
                adminMsgEl.textContent = ticket.admin_notes;
                adminMsgEl.style.fontStyle = "normal";
                adminMsgEl.style.color = "var(--shark-obsidian)";
                adminNode.style.opacity = "1";
            } else {
                adminMsgEl.textContent = "Your inquiry is currently in the audit buffer. A syndicate officer will respond shortly with a directive.";
                adminMsgEl.style.fontStyle = "italic";
                adminMsgEl.style.color = "var(--shark-muted)";
                adminNode.style.opacity = "0.6";
            }

            document.getElementById('detailModal').style.display = 'flex';
        }

        function closeDetailModal() { document.getElementById('detailModal').style.display = 'none'; }
        window.onload = loadTickets;
    </script>
</body>
</html>